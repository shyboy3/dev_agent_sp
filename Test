ì‹ ê·œ ì½”ë“œ

import os
import io
import asyncio
import base64
import json
import re
from typing import List, Dict, Any, Optional
from contextlib import asynccontextmanager

# --- [í•„ìˆ˜] í”„ë¡ì‹œ ê°•ì œ í•´ì œ ---
os.environ['NO_PROXY'] = '127.0.0.1,localhost,0.0.0.0,::1'
if 'HTTP_PROXY' in os.environ: del os.environ['HTTP_PROXY']
if 'HTTPS_PROXY' in os.environ: del os.environ['HTTPS_PROXY']
# ------------------------------

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
from scipy.ndimage import label, find_objects # â˜… í•µì‹¬ ì¶”ê°€: ì•„ì¼ëœë“œ ê°ì§€ìš©
from ollama import Client 
from PIL import Image
from pdf2image import convert_from_bytes
from pptx import Presentation
from pptx.enum.shapes import MSO_SHAPE_TYPE

# --- ì„¤ì • ---
OLLAMA_HOST = "http://127.0.0.1:11434" 
ollama_client = Client(host=OLLAMA_HOST)

VISION_MODEL = "qwen3-vl:30b-a3b-instruct" 
TEXT_MODEL = "llama3:70b"

# --- [í•µì‹¬] ì—‘ì…€ ì„¬(Island) ê°ì§€ ì•Œê³ ë¦¬ì¦˜ ---

def detect_excel_blocks(df: pd.DataFrame) -> List[pd.DataFrame]:
    """
    ì»´í“¨í„° ë¹„ì „ì˜ 'Connected Components Labeling'ì„ ì‚¬ìš©í•˜ì—¬
    ìƒí•˜ì¢Œìš°ë¡œ ë–¨ì–´ì§„ ëª¨ë“  ë°ì´í„° ë¸”ë¡ì„ ë…ë¦½ì ìœ¼ë¡œ ê°ì§€í•©ë‹ˆë‹¤.
    """
    blocks = []
    if df.empty: return blocks

    # 1. ë°ì´í„°ê°€ ìˆëŠ” ê³³ì„ True, ì—†ëŠ” ê³³ì„ Falseë¡œ ë§ˆìŠ¤í‚¹
    #    (í—¤ë”ë‚˜ ì¸ë±ìŠ¤ ì²˜ë¦¬ë¥¼ ìœ„í•´ ì¼ë‹¨ ì „ì²´ë¥¼ ë´„)
    mask = ~df.isnull().to_numpy() # numpy ë°°ì—´ë¡œ ë³€í™˜
    
    # 2. ì—°ê²°ëœ ìš”ì†Œ ë¼ë²¨ë§ (ëŒ€ê°ì„  ì—°ê²°ë„ í¬í•¨í•˜ë ¤ë©´ structure=[[1,1,1],[1,1,1],[1,1,1]])
    #    ì—¬ê¸°ì„œëŠ” ìƒí•˜ì¢Œìš° ì—°ê²°ë§Œ ì¸ì • (ì‹­ìê°€ êµ¬ì¡°)
    structure = [[0,1,0], [1,1,1], [0,1,0]]
    labeled_array, num_features = label(mask, structure=structure)
    
    if num_features == 0:
        return blocks

    # 3. ê° ë¼ë²¨(ì„¬)ë³„ë¡œ bounding box ì¶”ì¶œ
    slices = find_objects(labeled_array)
    
    for i, slice_obj in enumerate(slices):
        # slice_objëŠ” (row_slice, col_slice) íŠœí”Œì„
        # ì›ë³¸ ë°ì´í„°í”„ë ˆì„ì—ì„œ í•´ë‹¹ ì˜ì—­ë§Œ ì˜ë¼ëƒ„
        block = df.iloc[slice_obj]
        
        # 4. ë„ˆë¬´ ì‘ì€ ë¸”ë¡(ë…¸ì´ì¦ˆ) ì œê±° (ì˜ˆ: 2x2 ë¯¸ë§Œ)
        if block.shape[0] >= 2 and block.shape[1] >= 2:
            # ì¸ë±ìŠ¤ ì´ˆê¸°í™” (ê¹”ë”í•˜ê²Œ ì²˜ë¦¬í•˜ê¸° ìœ„í•¨)
            blocks.append(block.reset_index(drop=True))
            
    return blocks

async def analyze_vision_ollama(image_bytes: bytes, prompt: str) -> str:
    """Vision ëª¨ë¸ í˜¸ì¶œ"""
    try:
        img_b64 = base64.b64encode(image_bytes).decode('utf-8')
        response = await asyncio.to_thread(
            ollama_client.chat,
            model=VISION_MODEL,
            messages=[{'role': 'user', 'content': prompt, 'images': [img_b64]}]
        )
        content = response['message']['content']
        if "<script" in content or "mwg-internal" in content:
            return "[Error: Blocked by Firewall]"
        return content
    except Exception as e:
        return f"[Vision Error: {e}]"

# --- íŒŒì„œ (Parsers) ---

async def parse_excel_v5(content: bytes, filename: str, lang: str):
    """ì—‘ì…€ íŒŒì‹± (ê°œì„ ëœ ë¸”ë¡ ê°ì§€ ì ìš©)"""
    results = []
    try:
        xls = pd.ExcelFile(io.BytesIO(content))
        
        for sheet_name in xls.sheet_names:
            # í—¤ë” ì—†ì´ ì›ë³¸ ê·¸ëŒ€ë¡œ ì½ìŒ
            df = pd.read_excel(xls, sheet_name=sheet_name, header=None)
            
            # â˜… ê°œì„ ëœ ê°ì§€ ë¡œì§ í˜¸ì¶œ
            blocks = detect_excel_blocks(df)
            
            print(f"ğŸ“Š Sheet '{sheet_name}': Detected {len(blocks)} blocks.") # ë””ë²„ê¹…ìš© ë¡œê·¸

            for i, block in enumerate(blocks):
                # ì°¨íŠ¸ ë°ì´í„° ì¶”ì¶œ ì‹œë„
                chart_data = []
                try:
                    # ë¸”ë¡ ë‚´ì—ì„œ ìˆ«ìë¡œë§Œ êµ¬ì„±ëœ ê°€ì¥ í° ì˜ì—­ ì°¾ê¸°
                    # (í—¤ë”ë‚˜ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ì„ ì œì™¸í•˜ê¸° ìœ„í•¨)
                    num_block = block.apply(pd.to_numeric, errors='coerce')
                    num_block = num_block.dropna(how='all', axis=0).dropna(how='all', axis=1)
                    
                    if not num_block.empty and num_block.shape[0] > 2:
                        # ì²«ë²ˆì§¸ ìˆ«ì ì»¬ëŸ¼ = X, ë‘ë²ˆì§¸ ìˆ«ì ì»¬ëŸ¼ = Y
                        x = num_block.iloc[:, 0].fillna(0).values
                        y = num_block.iloc[:, 1].fillna(0).values if num_block.shape[1] > 1 else x
                        
                        # ë°ì´í„° í¬ì¸íŠ¸ê°€ ë„ˆë¬´ ë§ìœ¼ë©´ ìƒ˜í”Œë§
                        step = max(1, len(x) // 100)
                        chart_data = [{"x": float(v1), "y": float(v2)} for v1, v2 in zip(x[::step], y[::step])]
                except:
                    pass

                # LLMì—ê²Œ ì¤„ í…ìŠ¤íŠ¸ (ì•ë¶€ë¶„ 2000ì)
                raw_csv = block.to_csv(index=False, header=False)[:2000]
                
                results.append({
                    "type": "excel_block",
                    "filename": f"{filename} ({sheet_name} - Block {i+1})",
                    "summary": f"Data Block {i+1} found in sheet '{sheet_name}'. Contains {block.shape[0]} rows x {block.shape[1]} columns.",
                    "raw_context": f"Excel Data Block {i+1} ({sheet_name}):\n{raw_csv}",
                    "chart_data": chart_data,
                    "image_b64": None
                })
                
    except Exception as e:
        return [{"type": "error", "filename": filename, "msg": str(e)}]
    return results

async def parse_ppt_v4(content: bytes, filename: str, lang: str):
    """PPTX íŒŒì‹±"""
    try:
        prs = Presentation(io.BytesIO(content))
        slides_data = []
        full_context = ""
        lang_inst = "Korean" if lang == 'korean' else "English"

        for i, slide in enumerate(prs.slides):
            slide_text = []
            extracted_images = []
            
            for shape in slide.shapes:
                if hasattr(shape, "text") and shape.text.strip():
                    slide_text.append(shape.text)
                if shape.shape_type == MSO_SHAPE_TYPE.PICTURE:
                    try:
                        image_blob = shape.image.blob
                        img_b64 = base64.b64encode(image_blob).decode('utf-8')
                        prompt = f"Analyze this image in {lang_inst}. Explain scientific details."
                        desc = await analyze_vision_ollama(image_blob, prompt)
                        extracted_images.append({"b64": img_b64, "desc": desc})
                    except: pass

            combined_txt = "\n".join(slide_text)
            img_desc_combined = "\n".join([f"[Image]: {img['desc']}" for img in extracted_images])
            full_context += f"### Slide {i+1}\nText: {combined_txt}\nVisuals: {img_desc_combined}\n"
            
            slides_data.append({
                "slide_num": i+1,
                "text": combined_txt,
                "images": extracted_images
            })
            
        return {
            "type": "ppt",
            "filename": filename,
            "summary": f"**PPT Analysis ({len(prs.slides)} slides)**",
            "raw_context": full_context,
            "slides": slides_data
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def parse_pdf_v4(content: bytes, filename: str, lang: str):
    """PDF íŒŒì‹±"""
    try:
        images = convert_from_bytes(content, dpi=150, fmt='jpeg')
        pages_data = []
        full_context = ""
        lang_inst = "Korean" if lang == 'korean' else "English"
        
        print(f"ğŸ“„ PDF: {filename} ({len(images)} pages)")

        for i, img in enumerate(images):
            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_bytes = buffered.getvalue()
            img_b64 = base64.b64encode(img_bytes).decode('utf-8')
            
            prompt = f"""
            Analyze page {i+1} in {lang_inst}.
            1. Summarize content.
            2. Describe figures/tables clearly.
            3. No LaTeX. Plain text only.
            """
            print(f"   - Page {i+1} Vision Analysis...")
            page_desc = await analyze_vision_ollama(img_bytes, prompt)
            
            full_context += f"\n--- Page {i+1} ---\n{page_desc}\n"
            pages_data.append({"page_num": i+1, "image_b64": img_b64, "desc": page_desc})

        return {
            "type": "pdf",
            "filename": filename,
            "summary": f"**PDF Analysis ({len(images)} pages)**",
            "raw_context": full_context,
            "pages": pages_data
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": f"PDF Error: {str(e)}"}

async def parse_image_v4(content: bytes, filename: str, lang: str):
    try:
        img = Image.open(io.BytesIO(content)).convert("RGB")
        buffered = io.BytesIO()
        img.save(buffered, format="JPEG")
        img_bytes = buffered.getvalue()
        img_b64 = base64.b64encode(img_bytes).decode('utf-8')
        
        lang_inst = "Korean" if lang == 'korean' else "English"
        desc = await analyze_vision_ollama(img_bytes, f"Analyze in {lang_inst}. Focus on scientific details.")
        
        return {
            "type": "image",
            "filename": filename,
            "summary": desc,
            "image_b64": img_b64,
            "raw_context": desc
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def parse_spectrum(content: bytes, filename: str):
    try:
        try: df = pd.read_csv(io.BytesIO(content))
        except: df = pd.read_csv(io.BytesIO(content), delimiter='\t')
        x = df.iloc[:, 0].values
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        step = max(1, len(x) // 500)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Spectrum: {len(peaks)} peaks.",
            "chart_data": chart_data,
            "raw_context": f"Spectrum Peaks: {peaks}, Max: {np.max(y)}"
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

# --- ë©”ì¸ ë¼ìš°í„° ---
app = FastAPI(title="Analyst V5")
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

@app.post("/api/analyze")
async def analyze_orchestrator(
    files: List[UploadFile] = File(...),
    custom_prompt: Optional[str] = Form(""),
    language: str = Form("korean")
):
    print(f"ğŸš€ Processing Request. Lang: {language}")
    
    file_data_list = []
    for file in files:
        file_data_list.append({"name": file.filename, "content": await file.read()})
    
    tasks = []
    final_results = []
    
    for f in file_data_list:
        fname = f["name"].lower()
        content = f["content"]
        
        if fname.endswith(('.xlsx', '.xls')):
            # ì—‘ì…€ì€ ì¦‰ì‹œ ì²˜ë¦¬
            blocks = await parse_excel_v5(content, f["name"], language)
            final_results.extend(blocks)
        elif fname.endswith(('.ppt', '.pptx')):
            tasks.append(parse_ppt_v4(content, f["name"], language))
        elif fname.endswith('.pdf'):
            tasks.append(parse_pdf_v4(content, f["name"], language))
        elif fname.endswith(('.csv', '.txt')):
            tasks.append(parse_spectrum(content, f["name"]))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.tiff', '.bmp')):
            tasks.append(parse_image_v4(content, f["name"], language))

    other_results = await asyncio.gather(*tasks)
    final_results.extend(list(other_results))
    
    # ì¢…í•© ë¦¬í¬íŠ¸
    valid_data = [r for r in final_results if r.get("type") != "error"]
    context_text = ""
    for item in valid_data:
        raw = item.get("raw_context", "")
        if "mwg-internal" not in raw:
            context_text += f"\n=== Source: {item['filename']} ===\n{raw[:5000]}\n"

    lang_inst = "Korean" if language == 'korean' else "English"
    system_prompt = f"You are a Senior Scientist. Write the report in **{lang_inst}**. User Request: {custom_prompt}"
    
    final_report = "ë¶„ì„ ì‹¤íŒ¨"
    if context_text:
        try:
            print("ğŸ“ Synthesizing Report...")
            res = await asyncio.to_thread(
                ollama_client.chat,
                model=TEXT_MODEL,
                messages=[{'role': 'system', 'content': system_prompt}, {'role': 'user', 'content': context_text}]
            )
            final_report = res['message']['content']
        except Exception as e:
            final_report = f"Error: {e}"

    return {"results": final_results, "final_report": final_report}

@app.get("/", response_class=HTMLResponse)
async def serve_index():
    if os.path.exists("index.html"): return FileResponse("index.html")
    return "<h1>index.html not found</h1>"

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)







import os
import io
import asyncio
import base64
import json
import re
from typing import List, Dict, Any, Optional
from contextlib import asynccontextmanager

# --- [í•„ìˆ˜] í”„ë¡ì‹œ ê°•ì œ í•´ì œ (ë³´ì•ˆë§ ìš°íšŒ) ---
os.environ['NO_PROXY'] = '127.0.0.1,localhost,0.0.0.0,::1'
if 'HTTP_PROXY' in os.environ: del os.environ['HTTP_PROXY']
if 'HTTPS_PROXY' in os.environ: del os.environ['HTTPS_PROXY']
# ---------------------------------------------

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
from ollama import Client 
from PIL import Image
from pdf2image import convert_from_bytes
from pptx import Presentation
from pptx.enum.shapes import MSO_SHAPE_TYPE

# --- ì„¤ì • ---
OLLAMA_HOST = "http://127.0.0.1:11434" 
ollama_client = Client(host=OLLAMA_HOST)

# ëª¨ë¸ (ë³´ìœ í•˜ì‹  ëª¨ë¸ëª… í™•ì¸)
VISION_MODEL = "qwen3-vl:30b-a3b-instruct" 
TEXT_MODEL = "llama3:70b"

# --- ìœ í‹¸ë¦¬í‹° ---

def clean_latex(text: str) -> str:
    """ê°„ë‹¨í•œ LaTeX íƒœê·¸ ì œê±° (ê°€ë…ì„± í–¥ìƒ)"""
    # $...$ ì œê±°í•˜ê³  ë‚´ë¶€ í…ìŠ¤íŠ¸ë§Œ ë‚¨ê¸°ê±°ë‚˜, íŠ¹ìˆ˜ë¬¸ì ì™„í™”
    # ì—¬ê¸°ì„œëŠ” ë³µì¡í•œ ë³€í™˜ë³´ë‹¤, LLMì—ê²Œ Plain Textë¥¼ ìš”ì²­í•˜ëŠ” ê²ƒì´ ìš°ì„ ì„.
    return text

def detect_excel_blocks(df: pd.DataFrame) -> List[pd.DataFrame]:
    """ì—‘ì…€ ë¸”ë¡ ê°ì§€ ë¡œì§ ê°œì„ """
    blocks = []
    if df.empty: return blocks
    
    # ë°ì´í„°ê°€ ìˆëŠ” í–‰/ì—´ë§Œ ë‚¨ê¸°ê¸° (ì „ì²´ ê³µë°± ì œê±°)
    df = df.dropna(how='all', axis=0).dropna(how='all', axis=1)
    
    if df.empty: return blocks

    # ì¸ë±ìŠ¤ ë¦¬ì…‹í•˜ì—¬ ì—°ì†ì„± í™•ì¸
    df = df.reset_index(drop=True)
    
    # ê°„ë‹¨í•˜ê²Œ: 3í–‰ ì´ìƒ ì—°ì†ëœ ë¹ˆ í–‰ì´ ìˆìœ¼ë©´ ë¶„ë¦¬
    # (ë³µì¡í•œ ë¡œì§ ëŒ€ì‹ , í™•ì‹¤í•œ ë°ì´í„° ë©ì–´ë¦¬ë¥¼ ì°¾ìŒ)
    
    # 1. ì¼ë‹¨ ì „ì²´ë¥¼ í•˜ë‚˜ì˜ ë¸”ë¡ìœ¼ë¡œ ë³´ë˜, 
    # ë°ì´í„° íƒ€ì…ì´ ì„ì—¬ìˆê±°ë‚˜ í—¤ë”ê°€ ì¤‘ê°„ì— ë‚˜ì˜¤ë©´ ìª¼ê°œëŠ” ë°©ì‹ì€ ë³µì¡í•˜ë¯€ë¡œ
    # í˜„ì¬ëŠ” ì „ì²´ ì‹œíŠ¸ë¥¼ í•˜ë‚˜ì˜ ìœ íš¨ ë¸”ë¡ìœ¼ë¡œ ì²˜ë¦¬í•˜ë˜, 
    # ë„ˆë¬´ ë“¬ì„±ë“¬ì„±í•œ ê²½ìš°(Island)ë¥¼ ìœ„í•´ í´ëŸ¬ìŠ¤í„°ë§ì„ í•´ì•¼ í•¨.
    
    # ì—¬ê¸°ì„œëŠ” 'ë¹ˆ í–‰'ì„ ê¸°ì¤€ìœ¼ë¡œ ë‹¨ìˆœ ë¶„ë¦¬ (ê°€ì¥ íš¨ê³¼ì )
    is_empty = df.isnull().all(axis=1)
    groups = (is_empty != is_empty.shift()).cumsum()
    
    for _, group in df.groupby(groups):
        if not group.isnull().all().all(): # ë°ì´í„°ê°€ ìˆëŠ” ê·¸ë£¹ë§Œ
            # 2x2 ì´ìƒì¸ ê²½ìš°ë§Œ ë¸”ë¡ìœ¼ë¡œ ì¸ì •
            if group.shape[0] >= 2 and group.shape[1] >= 2:
                blocks.append(group)
                
    return blocks

async def analyze_vision_ollama(image_bytes: bytes, prompt: str) -> str:
    """Vision ëª¨ë¸ í˜¸ì¶œ"""
    try:
        img_b64 = base64.b64encode(image_bytes).decode('utf-8')
        response = await asyncio.to_thread(
            ollama_client.chat,
            model=VISION_MODEL,
            messages=[{'role': 'user', 'content': prompt, 'images': [img_b64]}]
        )
        content = response['message']['content']
        
        # ë³´ì•ˆë§ ì—ëŸ¬ í•„í„°ë§
        if "<script" in content or "mwg-internal" in content:
            return "[Error: Image Blocked by Firewall]"
        return content
    except Exception as e:
        return f"[Vision Error: {e}]"

# --- íŒŒì„œ (Parsers) ---

async def parse_excel_v4(content: bytes, filename: str, lang: str):
    """ì—‘ì…€ íŒŒì‹± (ëª¨ë“  ë¸”ë¡ ë°˜í™˜)"""
    results = []
    try:
        xls = pd.ExcelFile(io.BytesIO(content))
        for sheet_name in xls.sheet_names:
            df = pd.read_excel(xls, sheet_name=sheet_name, header=None)
            blocks = detect_excel_blocks(df)
            
            if not blocks: # ë¸”ë¡ ê°ì§€ ì‹¤íŒ¨ ì‹œ ì „ì²´ë¥¼ í•˜ë‚˜ë¡œ ì‹œë„
                blocks = [df]

            for i, block in enumerate(blocks):
                # ì°¨íŠ¸ ë°ì´í„° ì¶”ì¶œ ì‹œë„
                chart_data = []
                try:
                    # ìˆ«ì ì»¬ëŸ¼ë§Œ ì¶”ì¶œ
                    num_df = block.apply(pd.to_numeric, errors='coerce').dropna(axis=1, how='all')
                    if not num_df.empty and num_df.shape[0] > 1:
                        x = num_df.iloc[:, 0].fillna(0).values
                        y = num_df.iloc[:, 1].fillna(0).values if num_df.shape[1] > 1 else x
                        # ìƒ˜í”Œë§
                        step = max(1, len(x) // 100)
                        chart_data = [{"x": float(v1), "y": float(v2)} for v1, v2 in zip(x[::step], y[::step])]
                except:
                    pass

                # ë°ì´í„° ë¯¸ë¦¬ë³´ê¸° (í…ìŠ¤íŠ¸)
                raw_csv = block.to_csv(index=False, header=False)[:1000]
                
                results.append({
                    "type": "excel_block",
                    "filename": f"{filename} ({sheet_name} - Block {i+1})",
                    "summary": f"Data extracted from {sheet_name}, Block {i+1}.",
                    "raw_context": f"Excel Data ({sheet_name}):\n{raw_csv}",
                    "chart_data": chart_data,
                    "image_b64": None # ì—‘ì…€ì€ ì´ë¯¸ì§€ê°€ ì—†ìŒ
                })
    except Exception as e:
        return [{"type": "error", "filename": filename, "msg": str(e)}]
    return results

async def parse_ppt_v4(content: bytes, filename: str, lang: str):
    """PPTX íŒŒì‹± (ì´ë¯¸ì§€ ì¶”ì¶œ í¬í•¨)"""
    try:
        prs = Presentation(io.BytesIO(content))
        slides_data = []
        full_context = ""
        
        lang_instruction = "Korean" if lang == 'korean' else "English"

        for i, slide in enumerate(prs.slides):
            slide_text = []
            extracted_images = []
            
            # 1. í…ìŠ¤íŠ¸ ì¶”ì¶œ
            for shape in slide.shapes:
                if hasattr(shape, "text") and shape.text.strip():
                    slide_text.append(shape.text)
                
                # 2. ì´ë¯¸ì§€ ì¶”ì¶œ ë° ë¶„ì„
                if shape.shape_type == MSO_SHAPE_TYPE.PICTURE:
                    try:
                        image_blob = shape.image.blob
                        # Base64ë¡œ ë³€í™˜í•˜ì—¬ í”„ë¡ íŠ¸ì—”ë“œ ì „ì†¡ ì¤€ë¹„
                        img_b64 = base64.b64encode(image_blob).decode('utf-8')
                        
                        # Vision ë¶„ì„
                        prompt = f"Analyze this image in {lang_instruction}. If it's a chart, explain the trend."
                        desc = await analyze_vision_ollama(image_blob, prompt)
                        
                        extracted_images.append({
                            "b64": img_b64,
                            "desc": desc
                        })
                    except:
                        pass

            slide_txt_combined = "\n".join(slide_text)
            img_desc_combined = "\n".join([f"[Image]: {img['desc']}" for img in extracted_images])
            
            # ì»¨í…ìŠ¤íŠ¸ ëˆ„ì 
            full_context += f"### Slide {i+1}\nText: {slide_txt_combined}\nVisual Analysis: {img_desc_combined}\n"
            
            # ê²°ê³¼ êµ¬ì¡°í™”
            slides_data.append({
                "slide_num": i+1,
                "text": slide_txt_combined,
                "images": extracted_images # ì´ë¯¸ì§€ ë¦¬ìŠ¤íŠ¸
            })
            
        return {
            "type": "ppt",
            "filename": filename,
            "summary": f"**PPT Analysis ({len(prs.slides)} slides)**",
            "raw_context": full_context,
            "slides": slides_data # ìƒì„¸ ë°ì´í„° í¬í•¨
        }

    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def parse_pdf_v4(content: bytes, filename: str, lang: str):
    """PDF íŒŒì‹± (í˜ì´ì§€ë³„ ì´ë¯¸ì§€ ë° ìš”ì•½)"""
    try:
        images = convert_from_bytes(content, dpi=150, fmt='jpeg') # DPI ì¡°ì • (ì†ë„/ìš©ëŸ‰)
        pages_data = []
        full_context = ""
        
        lang_instruction = "Korean" if lang == 'korean' else "English"
        
        print(f"ğŸ“„ PDF Processing: {filename} ({len(images)} pages)")

        for i, img in enumerate(images):
            # ì´ë¯¸ì§€ Base64 ë³€í™˜ (í”„ë¡ íŠ¸ì—”ë“œ í‘œì‹œìš©)
            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_bytes = buffered.getvalue()
            img_b64 = base64.b64encode(img_bytes).decode('utf-8')
            
            # Vision ë¶„ì„
            # LaTeX ì¶œë ¥ì„ ë§‰ê¸° ìœ„í•´ Plain Text ìš”ì²­
            prompt = f"""
            Analyze this page in {lang_instruction}.
            1. Summarize the main content.
            2. If there are tables/charts, describe them in detail.
            3. Do NOT use LaTeX formatting (no $ symbols). Use plain text.
            4. Do NOT hallucinate image tags like <!-- image -->.
            """
            print(f"   - Analyzing Page {i+1}...")
            page_desc = await analyze_vision_ollama(img_bytes, prompt)
            
            full_context += f"\n--- Page {i+1} ---\n{page_desc}\n"
            
            pages_data.append({
                "page_num": i+1,
                "image_b64": img_b64,
                "desc": page_desc
            })

        return {
            "type": "pdf",
            "filename": filename,
            "summary": f"**PDF Analysis ({len(images)} pages)**",
            "raw_context": full_context,
            "pages": pages_data
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": f"PDF Error: {str(e)}"}

async def parse_image_v4(content: bytes, filename: str, lang: str):
    """ë‹¨ì¼ ì´ë¯¸ì§€ íŒŒì‹±"""
    try:
        img = Image.open(io.BytesIO(content)).convert("RGB")
        buffered = io.BytesIO()
        img.save(buffered, format="JPEG")
        img_bytes = buffered.getvalue()
        img_b64 = base64.b64encode(img_bytes).decode('utf-8')
        
        lang_instruction = "Korean" if lang == 'korean' else "English"
        desc = await analyze_vision_ollama(img_bytes, f"Analyze this image in {lang_instruction}. Focus on scientific details.")
        
        return {
            "type": "image",
            "filename": filename,
            "summary": desc,
            "image_b64": img_b64,
            "raw_context": desc
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def parse_spectrum(content: bytes, filename: str):
    """ìŠ¤í™íŠ¸ëŸ¼ (ì–¸ì–´ ë¬´ê´€, ìˆ˜ì¹˜ ë¶„ì„)"""
    try:
        try: df = pd.read_csv(io.BytesIO(content))
        except: df = pd.read_csv(io.BytesIO(content), delimiter='\t')
        x = df.iloc[:, 0].values
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        step = max(1, len(x) // 500)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Spectrum: {len(peaks)} peaks detected.",
            "chart_data": chart_data,
            "raw_context": f"Spectrum Peaks at: {peaks}, Max: {np.max(y)}"
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}


# --- ë©”ì¸ ë¼ìš°í„° ---
app = FastAPI(title="Analyst V4")
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

@app.post("/api/analyze")
async def analyze_orchestrator(
    files: List[UploadFile] = File(...),
    custom_prompt: Optional[str] = Form(""),
    language: str = Form("korean")
):
    print(f"ğŸš€ Processing V4 Request. Lang: {language}")
    
    file_data_list = []
    for file in files:
        file_data_list.append({"name": file.filename, "content": await file.read()})
    
    tasks = []
    final_results = []
    
    # 1. íƒœìŠ¤í¬ ìƒì„±
    for f in file_data_list:
        fname = f["name"].lower()
        content = f["content"]
        
        if fname.endswith(('.xlsx', '.xls')):
            # ì—‘ì…€ì€ ì¦‰ì‹œ ì²˜ë¦¬ (ê²°ê³¼ê°€ ë¦¬ìŠ¤íŠ¸ë¼ êµ¬ì¡°ìƒ ë¶„ë¦¬)
            blocks = await parse_excel_v4(content, f["name"], language)
            final_results.extend(blocks)
        elif fname.endswith(('.ppt', '.pptx')):
            tasks.append(parse_ppt_v4(content, f["name"], language))
        elif fname.endswith('.pdf'):
            tasks.append(parse_pdf_v4(content, f["name"], language))
        elif fname.endswith(('.csv', '.txt')):
            tasks.append(parse_spectrum(content, f["name"]))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.tiff', '.bmp')):
            tasks.append(parse_image_v4(content, f["name"], language))

    # 2. ë¹„ë™ê¸° ì‹¤í–‰
    other_results = await asyncio.gather(*tasks)
    final_results.extend(list(other_results))
    
    # 3. ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„±
    valid_data = [r for r in final_results if r.get("type") != "error"]
    context_text = ""
    for item in valid_data:
        # mwg-internal í•„í„°ë§
        raw = item.get("raw_context", "")
        if "mwg-internal" not in raw:
            context_text += f"\n=== Source: {item['filename']} ===\n{raw[:5000]}\n"

    lang_inst = "Korean (Hangul)" if language == 'korean' else "English"
    
    system_prompt = f"""
    You are a Senior Scientist. Synthesize the results.
    1. Write the report in **{lang_inst}**.
    2. Do NOT use LaTeX syntax for text. Use plain text.
    3. Interpret the data deeply.
    4. User Request: "{custom_prompt}"
    """
    
    final_report = "ë¶„ì„ ì‹¤íŒ¨"
    if context_text:
        try:
            print("ğŸ“ Synthesizing Report...")
            res = await asyncio.to_thread(
                ollama_client.chat,
                model=TEXT_MODEL,
                messages=[
                    {'role': 'system', 'content': system_prompt},
                    {'role': 'user', 'content': f"Analysis Data:\n{context_text}"}
                ]
            )
            final_report = res['message']['content']
        except Exception as e:
            final_report = f"Synthesis Error: {e}"

    return {"results": final_results, "final_report": final_report}

@app.get("/", response_class=HTMLResponse)
async def serve_index():
    if os.path.exists("index.html"): return FileResponse("index.html")
    return "<h1>index.html not found</h1>"

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)






<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Analyst V4 (Pro)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ê°•ì œ ì ìš© (ë ˆì´ì•„ì›ƒ ê¹¨ì§ ë°©ì§€) */
        .prose { 
            max-width: none; 
            overflow-wrap: break-word; 
            word-wrap: break-word; 
            word-break: break-word;
        }
        .prose pre { white-space: pre-wrap; word-break: break-all; }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg">
                    <i data-lucide="microscope" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">AI Analyst V4</h1>
                    <p class="text-sm text-slate-500">Dual GPU / Multi-Block Excel / PDF Full Parse</p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Panel -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Upload -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="font-bold mb-4 flex items-center gap-2">Files</h2>
                    <div 
                        class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50"
                        @click="$refs.fileInput.click()"
                        @drop.prevent="handleDrop" @dragover.prevent
                    >
                        <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                        <p class="font-semibold text-slate-600">Click to Upload</p>
                    </div>
                    <div class="mt-4 space-y-2">
                        <div v-for="(f, i) in files" :key="i" class="flex justify-between p-2 bg-slate-50 rounded text-sm">
                            <span class="truncate">{{ f.name }}</span>
                            <button @click="removeFile(i)" class="text-red-400">x</button>
                        </div>
                    </div>
                </div>

                <!-- Options -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="font-bold mb-4">Options</h2>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Language</label>
                        <select v-model="language" class="w-full p-2 bg-slate-50 border rounded">
                            <option value="korean">í•œê¸€ (Korean)</option>
                            <option value="english">English</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Custom Prompt</label>
                        <textarea v-model="customPrompt" class="w-full p-2 bg-slate-50 border rounded text-sm" rows="3"></textarea>
                    </div>
                    <button @click="analyze" :disabled="isAnalyzing || files.length===0" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold flex justify-center gap-2">
                        <div v-if="isAnalyzing" class="loader"></div>
                        <span>{{ isAnalyzing ? 'Analyzing...' : 'Start Analysis' }}</span>
                    </button>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="lg:col-span-8">
                <div v-if="result" class="space-y-6 animate-fade-in-up">
                    <div class="flex justify-end">
                        <button @click="downloadPDF" class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-900 text-sm">Download PDF</button>
                    </div>

                    <div id="report-content" class="bg-white p-10 rounded-2xl shadow-sm border border-slate-100">
                        <h1 class="text-3xl font-bold mb-2">Final Report</h1>
                        <p class="text-slate-400 text-sm mb-8">{{ new Date().toLocaleString() }}</p>

                        <!-- Executive Synthesis -->
                        <section class="mb-12">
                            <h2 class="text-xl font-bold text-indigo-700 mb-4 border-b pb-2">1. Executive Synthesis</h2>
                            <div class="prose text-slate-700" v-html="renderMarkdown(result.final_report)"></div>
                        </section>

                        <!-- Visual Evidence -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-800 mb-6 border-b pb-2">2. Visual Evidence & Data</h2>

                            <div v-for="(item, idx) in result.results" :key="idx" class="mb-10 break-inside-avoid">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="px-2 py-1 bg-slate-100 rounded text-xs font-bold uppercase">{{ item.type }}</span>
                                    <h3 class="font-bold text-lg">{{ item.filename }}</h3>
                                </div>

                                <!-- 1. PDF Viewer (All Pages) -->
                                <div v-if="item.type === 'pdf' && item.pages" class="space-y-6">
                                    <div v-for="page in item.pages" :key="page.page_num" class="bg-slate-50 p-4 rounded border border-slate-200 flex gap-4 break-inside-avoid">
                                        <!-- Page Image -->
                                        <div class="w-1/3 flex-shrink-0">
                                            <img :src="'data:image/jpeg;base64,' + page.image_b64" class="w-full rounded border shadow-sm">
                                            <p class="text-center text-xs text-slate-400 mt-1">Page {{ page.page_num }}</p>
                                        </div>
                                        <!-- Page Analysis -->
                                        <div class="w-2/3 text-sm prose" v-html="renderMarkdown(page.desc)"></div>
                                    </div>
                                </div>

                                <!-- 2. PPT Viewer (Slides & Extracted Images) -->
                                <div v-if="item.type === 'ppt' && item.slides" class="space-y-6">
                                    <div v-for="slide in item.slides" :key="slide.slide_num" class="bg-slate-50 p-4 rounded border border-slate-200 break-inside-avoid">
                                        <h4 class="font-bold text-sm mb-2 text-indigo-600">Slide {{ slide.slide_num }}</h4>
                                        <!-- Slide Text -->
                                        <div class="text-sm mb-4 whitespace-pre-wrap">{{ slide.text }}</div>
                                        <!-- Extracted Images -->
                                        <div v-if="slide.images && slide.images.length > 0" class="grid grid-cols-2 gap-4">
                                            <div v-for="(img, imgIdx) in slide.images" :key="imgIdx" class="bg-white p-2 rounded border">
                                                <img :src="'data:image/jpeg;base64,' + img.b64" class="max-h-40 mx-auto object-contain">
                                                <p class="text-xs text-slate-500 mt-2 p-2 bg-slate-50 rounded">{{ img.desc }}</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 3. Excel Charts -->
                                <div v-if="item.type === 'excel_block' || item.type === 'spectrum'" class="bg-slate-50 p-4 rounded border">
                                    <div v-if="item.chart_data && item.chart_data.length > 0">
                                        <div :id="'chart-' + idx" class="w-full h-64 bg-white"></div>
                                    </div>
                                    <div class="mt-4 text-sm prose" v-html="renderMarkdown(item.summary)"></div>
                                </div>

                                <!-- 4. Single Image -->
                                <div v-if="item.type === 'image'" class="bg-slate-50 p-4 rounded border text-center">
                                    <img :src="'data:image/jpeg;base64,' + item.image_b64" class="max-h-96 mx-auto rounded shadow-sm">
                                    <div class="mt-4 text-sm text-left prose" v-html="renderMarkdown(item.summary)"></div>
                                </div>

                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);
                const customPrompt = ref("");
                const language = ref("korean");

                // Remove Image tags from Markdown to prevent 403 errors
                const renderer = new marked.Renderer();
                renderer.image = function() { return ''; };
                marked.use({ renderer });

                const handleFileSelect = (e) => files.value.push(...Array.from(e.target.files));
                const handleDrop = (e) => files.value.push(...Array.from(e.dataTransfer.files));
                const removeFile = (i) => files.value.splice(i, 1);
                const renderMarkdown = (text) => marked.parse(text || '');

                const analyze = async () => {
                    isAnalyzing.value = true;
                    result.value = null;
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));
                    formData.append('custom_prompt', customPrompt.value);
                    formData.append('language', language.value);

                    try {
                        const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                        const data = await res.json();
                        result.value = data;
                        await nextTick();
                        drawCharts(data.results);
                        lucide.createIcons();
                    } catch (e) {
                        alert(e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.chart_data && item.chart_data.length > 0) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: { color: '#4f46e5' }
                            };
                            Plotly.newPlot('chart-' + idx, [trace], {
                                margin: { t: 10, b: 30, l: 40, r: 10 },
                                xaxis: { title: 'X' }, yaxis: { title: 'Y' }
                            }, {displayModeBar: false});
                        }
                    });
                };

                const downloadPDF = () => {
                    const el = document.getElementById('report-content');
                    html2pdf().set({
                        margin: 10, filename: 'Report.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    }).from(el).save();
                };

                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result, customPrompt, language,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown, downloadPDF
                };
            }
        }).mount('#app');
    </script>
</body>
</html>


