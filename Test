index.html

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A6000 AI Lab Analyst</title>
    
    <!-- 1. ìŠ¤íƒ€ì¼ ë„êµ¬ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. ë°˜ì‘í˜• ë¡œì§ ë„êµ¬ (Vue.js 3) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 3. ì°¨íŠ¸ ë„êµ¬ (Plotly.js) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- 4. ë§ˆí¬ë‹¤ìš´ ë Œë”ëŸ¬ (Marked) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 5. ì•„ì´ì½˜ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="microscope" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">A6000 Multi-modal Analyst</h1>
                    <p class="text-sm text-slate-500">Dual GPU Powered Local Analysis System</p>
                </div>
            </div>
            <div class="flex gap-2 text-xs font-mono bg-slate-200 px-3 py-1 rounded">
                <span class="text-green-600">â— System Ready</span>
                <span>|</span>
                <span>GPU: A6000 x2</span>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left: Upload & Status -->
            <div class="space-y-6">
                <!-- Dropzone -->
                <div 
                    class="bg-white p-8 rounded-xl shadow-sm border-2 border-dashed border-indigo-100 hover:border-indigo-400 transition-colors text-center cursor-pointer"
                    @dragover.prevent
                    @drop.prevent="handleDrop"
                    @click="$refs.fileInput.click()"
                >
                    <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                    <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-indigo-300 mb-4"></i>
                    <p class="font-medium text-slate-700">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                    <p class="text-xs text-slate-400 mt-2">CSV, PNG, JPG, PDF ì§€ì›</p>
                </div>

                <!-- File List -->
                <div v-if="files.length > 0" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-sm">
                        ì—…ë¡œë“œ ëŒ€ê¸° ëª©ë¡ ({{ files.length }})
                    </div>
                    <ul class="max-h-60 overflow-y-auto">
                        <li v-for="(file, index) in files" :key="index" class="p-3 border-b last:border-0 flex justify-between items-center text-sm">
                            <span class="truncate max-w-[200px]">{{ file.name }}</span>
                            <button @click.stop="removeFile(index)" class="text-red-400 hover:text-red-600">Ã—</button>
                        </li>
                    </ul>
                    <div class="p-4">
                        <button 
                            @click="analyze" 
                            :disabled="isAnalyzing"
                            class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span v-if="isAnalyzing" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></span>
                            {{ isAnalyzing ? 'ë¶„ì„ ì¤‘...' : 'ì¢…í•© ë¶„ì„ ì‹¤í–‰' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Initial State -->
                <div v-if="!result && !isAnalyzing" class="h-96 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center text-slate-400">
                    <i data-lucide="bar-chart-2" class="w-16 h-16 mb-4 opacity-50"></i>
                    <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <!-- Analysis Results -->
                <div v-if="result" class="space-y-6 animate-fade-in">
                    
                    <!-- 1. Final Report -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-800">
                            <i data-lucide="file-text"></i> ì¢…í•© ë¦¬í¬íŠ¸
                        </h2>
                        <div class="prose prose-slate max-w-none" v-html="renderMarkdown(result.final_report)"></div>
                    </div>

                    <!-- 2. Individual Results -->
                    <div v-for="(item, idx) in result.results" :key="idx" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        
                        <!-- Spectrum Type -->
                        <div v-if="item.type === 'spectrum'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="activity"></i> {{ item.filename }}
                            </h3>
                            <p class="text-sm text-slate-500 mb-4">{{ item.summary }}</p>
                            <!-- Chart Container -->
                            <div :id="'chart-' + idx" class="w-full h-64 bg-slate-50 rounded"></div>
                        </div>

                        <!-- Image Type -->
                        <div v-if="item.type === 'image'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="image"></i> {{ item.filename }}
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <img :src="'data:image/jpeg;base64,' + item.image_b64" class="rounded border border-slate-200 max-h-64 object-contain">
                                <div class="text-sm text-slate-600 bg-slate-50 p-4 rounded">
                                    <strong>AI Analysis:</strong><br>
                                    {{ item.summary }}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);

                const handleFileSelect = (e) => {
                    files.value.push(...Array.from(e.target.files));
                };

                const handleDrop = (e) => {
                    files.value.push(...Array.from(e.dataTransfer.files));
                };

                const removeFile = (index) => {
                    files.value.splice(index, 1);
                };

                const renderMarkdown = (text) => {
                    return marked.parse(text || '');
                };

                const analyze = async () => {
                    if (files.value.length === 0) return;
                    
                    isAnalyzing.value = true;
                    result.value = null;
                    
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));

                    try {
                        const response = await fetch('/api/analyze', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        result.value = data;

                        // Wait for DOM update then draw charts
                        await nextTick();
                        drawCharts(data.results);
                        
                        // Re-initialize icons
                        lucide.createIcons();

                    } catch (e) {
                        alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.type === 'spectrum' && item.chart_data) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: {color: '#4f46e5'},
                                name: 'Signal'
                            };
                            
                            // Peaks
                            const peaks = {
                                x: item.peaks.map(p => p.x),
                                y: item.peaks.map(p => p.y),
                                mode: 'markers',
                                marker: {color: 'red', size: 8},
                                name: 'Peaks'
                            };

                            const layout = {
                                margin: {t: 20, b: 40, l: 40, r: 20},
                                showlegend: false,
                                xaxis: {title: 'Wavelength/Index'},
                                yaxis: {title: 'Intensity'}
                            };

                            Plotly.newPlot('chart-' + idx, [trace, peaks], layout);
                        }
                    });
                };

                // Initialize icons on mount
                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>



main.py

import os
import io
import asyncio
import base64
import json
from typing import List, Dict, Any
from contextlib import asynccontextmanager

from fastapi import FastAPI, UploadFile, File
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
import cv2
from ollama import Client 
from PIL import Image
from pdf2image import convert_from_bytes

# --- 0. ì‚¬ìš©ì í™˜ê²½ ì„¤ì • (User Config) ---

# 1. Ollama ì£¼ì†Œ (ìœˆë„ìš° í™˜ê²½ ê³ ë ¤ ëª…ì‹œì  ì§€ì •)
OLLAMA_HOST = "http://127.0.0.1:11434"

# 2. ì‚¬ìš©í•  ëª¨ë¸ ì´ë¦„ (ollama list ëª…ë ¹ì–´ë¡œ í™•ì¸ëœ ì´ë¦„ì´ì–´ì•¼ í•¨)
# ì‚¬ìš©ì ìš”ì²­ ëª¨ë¸: qwen3-vl:30b-a3b-instruct
VISION_MODEL = "qwen3-vl:30b-a3b-instruct"  
TEXT_MODEL = "llama3:70b"  # ì¢…í•© ë¦¬í¬íŠ¸ìš© (ì—†ìœ¼ë©´ llama3ë¡œ ë³€ê²½)

# í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
ollama_client = Client(host=OLLAMA_HOST)

# --- 1. ì„œë²„ ìˆ˜ëª…ì£¼ê¸° ê´€ë¦¬ ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    print(f"ğŸš€ Starting A6000 Analysis Server (Ollama Mode)")
    print(f"ğŸ¯ Vision Model: {VISION_MODEL}")
    print(f"ğŸ¯ Text Model:   {TEXT_MODEL}")
    
    # ì—°ê²° í…ŒìŠ¤íŠ¸
    try:
        print(f"ğŸ“¡ Connecting to Ollama at {OLLAMA_HOST}...")
        models = ollama_client.list()
        
        # ëª¨ë¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ì‹¤í–‰ì€ ê³„ì†í•¨)
        installed_models = [m['name'] for m in models['models']]
        if VISION_MODEL not in installed_models:
            print(f"âš ï¸ Warning: Vision model '{VISION_MODEL}' not found in 'ollama list'.")
            print(f"   (It might download automatically upon first request, or check the name.)")
        else:
            print(f"âœ… Vision Model '{VISION_MODEL}' is ready.")
            
    except Exception as e:
        print(f"âŒ Error connecting to Ollama: {e}")
        print("   Please ensure 'ollama serve' is running!")
    
    yield
    print("ğŸ‘‹ Shutting down server...")

app = FastAPI(title="Ollama Native Analyst", lifespan=lifespan)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 2. ë¶„ì„ í•¨ìˆ˜ë“¤ (Ollama API í™œìš©) ---

async def analyze_with_vision_model(image_bytes: bytes, prompt: str) -> str:
    """ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜í•˜ì—¬ Ollama Vision ëª¨ë¸ì—ê²Œ ì „ì†¡"""
    try:
        # Base64 ì¸ì½”ë”©
        img_b64 = base64.b64encode(image_bytes).decode('utf-8')
        
        # ë¹„ë™ê¸° ì‹¤í–‰ì„ ìœ„í•´ to_thread ì‚¬ìš©
        response = await asyncio.to_thread(
            ollama_client.chat,
            model=VISION_MODEL,
            messages=[{
                'role': 'user',
                'content': prompt,
                'images': [img_b64]
            }]
        )
        return response['message']['content']
    except Exception as e:
        return f"[Vision AI Error] {str(e)}"

async def analyze_pdf(content: bytes, filename: str):
    """PDF -> Image -> Ollama Vision (Page by Page)"""
    try:
        # Popplerë¥¼ ì´ìš©í•´ PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        # (Windows í™˜ê²½ë³€ìˆ˜ PATHì— poppler/binì´ ìˆì–´ì•¼ í•¨)
        images = convert_from_bytes(content, first_page=1, last_page=3, fmt='jpeg')
        
        full_text = ""
        preview_image_b64 = None

        print(f"ğŸ“„ Processing PDF: {filename} ({len(images)} pages sample)")

        for i, img in enumerate(images):
            # ì²« í˜ì´ì§€ëŠ” ì¸ë„¤ì¼ìš©ìœ¼ë¡œ ì €ì¥
            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_bytes = buffered.getvalue()
            
            if i == 0:
                preview_image_b64 = base64.b64encode(img_bytes).decode('utf-8')

            # Vision AI ë¶„ì„ ìš”ì²­
            print(f"   Analyzing Page {i+1} with {VISION_MODEL}...")
            page_content = await analyze_with_vision_model(
                img_bytes, 
                "Transcribe this page into Markdown format. Keep tables and headers structurally correct. Do not summarize, just extract."
            )
            full_text += f"\n--- Page {i+1} ---\n{page_content}\n"

        return {
            "type": "image", # í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ image íƒ€ì… ì‚¬ìš©
            "filename": filename,
            "summary": f"**PDF Analysis ({VISION_MODEL})**\n\n{full_text}",
            "image_b64": preview_image_b64
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": f"PDF Error: {str(e)} (Check Poppler installed?)"}

async def analyze_image(content: bytes, filename: str):
    """ì¼ë°˜ ì´ë¯¸ì§€ ë¶„ì„"""
    try:
        img_b64 = base64.b64encode(content).decode('utf-8')
        
        print(f"ğŸ–¼ï¸ Analyzing Image: {filename}")
        description = await analyze_with_vision_model(
            content, 
            "Analyze this scientific image in detail. Identify defects, patterns, or key features."
        )
        
        return {
            "type": "image",
            "filename": filename,
            "summary": description,
            "image_b64": img_b64
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def analyze_spectrum(content: bytes, filename: str):
    """ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„ (ê¸°ì¡´ SciPy ë¡œì§)"""
    try:
        try:
            df = pd.read_csv(io.BytesIO(content))
        except:
            df = pd.read_csv(io.BytesIO(content), delimiter='\t')
            
        x = df.iloc[:, 0].values
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        
        step = max(1, len(x) // 1000)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
        peak_vals = [{"x": float(x[p]), "y": float(y[p])} for p in peaks]

        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Detected {len(peaks)} major peaks via Signal Processing.",
            "chart_data": chart_data,
            "peaks": peak_vals
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

# --- 3. ë¼ìš°íŒ… ë° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ---

@app.post("/api/analyze")
async def analyze_orchestrator(files: List[UploadFile] = File(...)):
    tasks = []
    
    for file in files:
        content = await file.read()
        fname = file.filename.lower()
        
        if fname.endswith('.pdf'):
            tasks.append(analyze_pdf(content, file.filename))
        elif fname.endswith(('.csv', '.txt', '.tsv')):
            tasks.append(analyze_spectrum(content, file.filename))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.bmp')):
            tasks.append(analyze_image(content, file.filename))
            
    # ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘
    results = await asyncio.gather(*tasks)
    
    # ê²°ê³¼ ì·¨í•© ë° ì¢…í•© ë¦¬í¬íŠ¸ ì‘ì„±
    valid_results = [r for r in results if r.get("type") != "error"]
    context_texts = []
    
    for r in valid_results:
        summary = r.get("summary", "")
        context_texts.append(f"--- File: {r['filename']} ---\n{summary[:3000]}") # ë„ˆë¬´ ê¸¸ë©´ ìë¦„
    
    final_context = "\n".join(context_texts)
    final_report = "ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    if final_context:
        try:
            print(f"ğŸ“ Generating Final Report with {TEXT_MODEL}...")
            res = await asyncio.to_thread(
                ollama_client.chat,
                model=TEXT_MODEL,
                messages=[{
                    'role': 'user', 
                    'content': f"Synthesize these scientific analysis results into a structured Markdown report. Highlight correlations between different data sources:\n\n{final_context}"
                }]
            )
            final_report = res['message']['content']
            print("âœ… Report Generated!")
            
        except Exception as e:
            final_report = f"âŒ Final Report Error: {str(e)}"

    return {
        "results": results,
        "final_report": final_report
    }

@app.get("/", response_class=HTMLResponse)
async def serve_index():
    if os.path.exists("index.html"):
        return FileResponse("index.html")
    return "<h1>index.html not found</h1>"

if __name__ == "__main__":
    import uvicorn
    # ì‹¤í–‰
    uvicorn.run(app, host="0.0.0.0", port=8000)


# ... (ìœ„ìª½ import ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...

@asynccontextmanager
async def lifespan(app: FastAPI):
    print(f"ğŸš€ Starting A6000 Analysis Server (Ollama Mode)")
    print(f"ğŸ¯ Vision Model: {VISION_MODEL}")
    print(f"ğŸ¯ Text Model:   {TEXT_MODEL}")
    
    # ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ëª¨ë¸ í™•ì¸ ë¡œì§ (ì•ˆì „í•˜ê²Œ ìˆ˜ì •ë¨)
    try:
        print(f"ğŸ“¡ Connecting to Ollama at {OLLAMA_HOST}...")
        
        # 1. ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        response = ollama_client.list()
        
        # 2. ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ (êµ¬ì¡° ë³€í™”ì— ëŒ€ì‘)
        # responseê°€ dictë¼ë©´ 'models' í‚¤ë¥¼ ì°¾ê³ , ì•„ë‹ˆë©´ response ìì²´ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ê°€ì •
        raw_models = response.get('models', []) if isinstance(response, dict) else response

        # 3. ì„¤ì¹˜ëœ ëª¨ë¸ ì´ë¦„ ì¶”ì¶œ (name í‚¤ê°€ ì—†ìœ¼ë©´ model í‚¤ë¥¼ ì‚¬ìš©)
        installed_models = []
        for m in raw_models:
            # mì´ ë”•ì…”ë„ˆë¦¬ì¸ ê²½ìš°
            if isinstance(m, dict):
                # 'name'ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ 'model'ì„ ì”€
                m_name = m.get('name') or m.get('model')
            else:
                # mì´ ê°ì²´(Object)ì¸ ê²½ìš° ì†ì„±ìœ¼ë¡œ ì ‘ê·¼
                m_name = getattr(m, 'name', None) or getattr(m, 'model', None)
            
            if m_name:
                installed_models.append(m_name)
        
        print(f"ğŸ“‹ Installed Models: {installed_models}")

        # 4. ëª¨ë¸ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
        # ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šì•„ë„ ë¶€ë¶„ ì¼ì¹˜í•˜ë©´ í†µê³¼ (íƒœê·¸ ë²„ì „ ì°¨ì´ ë“± ë°©ì§€)
        is_vision_ready = any(VISION_MODEL in m for m in installed_models)
        
        if not is_vision_ready:
            print(f"âš ï¸ Warning: Vision model '{VISION_MODEL}' might not be pulled yet.")
            print(f"   (Detected models: {installed_models})")
            print(f"   If execution fails, run: ollama pull {VISION_MODEL}")
        else:
            print(f"âœ… Vision Model '{VISION_MODEL}' is ready.")
            
    except Exception as e:
        # ì—ëŸ¬ê°€ ë‚˜ë„ ì„œë²„ê°€ êº¼ì§€ì§€ ì•Šë„ë¡ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ë„˜ì–´ê°
        print(f"âš ï¸ Warning: Check Ollama Connection (Error: {e})")
        print("   Proceeding anyway... (Server will try to connect on demand)")
    
    yield
    print("ğŸ‘‹ Shutting down server...")

# ... (ì•„ë˜ìª½ app = FastAPI(...) ë¶€í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) ...


í”„ë¡œí˜ì…”ë„ ì½”ë“œ

import os
import io
import asyncio
import base64
import json
from typing import List, Dict, Any, Optional
from contextlib import asynccontextmanager

from fastapi import FastAPI, UploadFile, File, Form
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
from ollama import Client 
from PIL import Image
from pdf2image import convert_from_bytes
from pptx import Presentation
from pptx.enum.shapes import MSO_SHAPE_TYPE

# --- 0. ì‚¬ìš©ì í™˜ê²½ ì„¤ì • ---
OLLAMA_HOST = "http://127.0.0.1:11434"
ollama_client = Client(host=OLLAMA_HOST)

# ëª¨ë¸ ì„¤ì • (ë³´ìœ í•˜ì‹  ëª¨ë¸ëª…ìœ¼ë¡œ ì •í™•íˆ ê¸°ì…)
VISION_MODEL = "qwen3-vl:30b-a3b-instruct" 
TEXT_MODEL = "llama3:70b"

# --- 1. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---

def detect_excel_blocks(df: pd.DataFrame) -> List[pd.DataFrame]:
    """
    ì—‘ì…€ ì‹œíŠ¸ ë‚´ì—ì„œ ë¹ˆ í–‰/ì—´ë¡œ êµ¬ë¶„ëœ ë°ì´í„° ë¸”ë¡(Island)ë“¤ì„ ì°¾ì•„ë‚´ëŠ” í•¨ìˆ˜
    """
    blocks = []
    if df.empty:
        return blocks

    # 1. ë¹ˆ í–‰(all NaN) ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ”
    # isnull().all(axis=1) -> í–‰ ì „ì²´ê°€ ë¹„ì—ˆìœ¼ë©´ True
    # diff() != 0 -> ìƒíƒœê°€ ë³€í•˜ëŠ” ì§€ì (ë°ì´í„° <-> ë¹ˆê³µê°„) ì°¾ê¸°
    mask = df.isnull().all(axis=1)
    # ë°ì´í„°ê°€ ìˆëŠ” í–‰ë“¤ì˜ ê·¸ë£¹ì„ ì°¾ìŒ
    data_rows = df[~mask]
    
    if data_rows.empty:
        return blocks

    # ì—°ì†ëœ ì¸ë±ìŠ¤ë¥¼ ê·¸ë£¹í™”í•˜ì—¬ ë¸”ë¡ ì¶”ì¶œ
    # (ì¸ë±ìŠ¤ ì°¨ì´ê°€ 1ë³´ë‹¤ í¬ë©´ ë¸”ë¡ì´ ëŠê¸´ ê²ƒ)
    groups = (data_rows.index.to_series().diff() > 1).cumsum()
    
    for _, group in data_rows.groupby(groups):
        # 2. ê° í–‰ ë¸”ë¡ ë‚´ì—ì„œ ë¹ˆ ì—´(all NaN) ì œê±° (Trim)
        block = group.dropna(axis=1, how='all')
        if not block.empty and block.shape[0] > 1 and block.shape[1] > 1:
            blocks.append(block)
            
    return blocks

async def analyze_vision_ollama(image_bytes: bytes, prompt: str) -> str:
    """Ollama Vision ëª¨ë¸ í˜¸ì¶œ"""
    try:
        img_b64 = base64.b64encode(image_bytes).decode('utf-8')
        response = await asyncio.to_thread(
            ollama_client.chat,
            model=VISION_MODEL,
            messages=[{'role': 'user', 'content': prompt, 'images': [img_b64]}]
        )
        return response['message']['content']
    except Exception as e:
        return f"[Vision Error] {e}"

# --- 2. íŒŒì„œ ì—”ì§„ (Parsers) ---

async def parse_excel_advanced(content: bytes, filename: str):
    """ë©€í‹° ì‹œíŠ¸, ë©€í‹° ë¸”ë¡ ì—‘ì…€ íŒŒì‹±"""
    results = []
    try:
        # ëª¨ë“  ì‹œíŠ¸ ë¡œë“œ
        xls = pd.ExcelFile(io.BytesIO(content))
        
        for sheet_name in xls.sheet_names:
            df = pd.read_excel(xls, sheet_name=sheet_name, header=None)
            
            # ìŠ¤ë§ˆíŠ¸ ë¸”ë¡ ê°ì§€
            blocks = detect_excel_blocks(df)
            
            for i, block in enumerate(blocks):
                # ë¸”ë¡ì˜ ì²« í–‰ì„ í—¤ë”ë¡œ ê°€ì •í•˜ê³  ì •ë¦¬
                # ì‹¤ì œ ë°ì´í„° ë¶„ì„ (ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ìˆ˜ì¹˜í˜• ë°ì´í„°ë§Œ ì¶”ì¶œí•˜ì—¬ ì°¨íŠ¸í™”)
                # ë³µì¡í•œ ë¡œì§ ëŒ€ì‹ , LLMì—ê²Œ Raw Textë¥¼ ì¤ë‹ˆë‹¤.
                
                # DataFrame to String
                block_str = block.to_csv(index=False, header=False)
                
                # ì°¨íŠ¸ìš© ë°ì´í„° ì¶”ì¶œ (ê°€ëŠ¥í•˜ë‹¤ë©´)
                chart_data = []
                try:
                    # ìˆ«ìë§Œ ìˆëŠ” ì»¬ëŸ¼ ì°¾ê¸°
                    numeric_block = block.apply(pd.to_numeric, errors='coerce')
                    valid_cols = numeric_block.dropna(axis=1, how='all')
                    if not valid_cols.empty and valid_cols.shape[0] > 2:
                        # ì²«ë²ˆì§¸ ì»¬ëŸ¼ X, ë‘ë²ˆì§¸ ì»¬ëŸ¼ Y ê°€ì • (ê°„ì´ ë¡œì§)
                        x = valid_cols.iloc[:, 0].fillna(0).values
                        y = valid_cols.iloc[:, 1].fillna(0).values if valid_cols.shape[1] > 1 else x
                        # ìƒ˜í”Œë§
                        step = max(1, len(x) // 100)
                        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
                except:
                    pass

                results.append({
                    "type": "excel_block",
                    "filename": f"{filename} (Sheet: {sheet_name}, Block {i+1})",
                    "summary": f"**Data Block {i+1} in {sheet_name}**\nRaw Data Preview:\n{block_str[:500]}...",
                    "raw_data": block_str[:2000], # LLM Contextìš©
                    "chart_data": chart_data
                })
                
    except Exception as e:
        return [{"type": "error", "filename": filename, "msg": str(e)}]
        
    return results

async def parse_ppt_advanced(content: bytes, filename: str):
    """PPT í…ìŠ¤íŠ¸ ë° ì´ë¯¸ì§€ ì¶”ì¶œ"""
    slides_data = []
    try:
        prs = Presentation(io.BytesIO(content))
        
        full_text_summary = ""
        
        for i, slide in enumerate(prs.slides):
            slide_text = []
            slide_images = []
            
            # Shape ìˆœíšŒ
            for shape in slide.shapes:
                # 1. í…ìŠ¤íŠ¸ ì¶”ì¶œ
                if hasattr(shape, "text") and shape.text.strip():
                    slide_text.append(shape.text)
                
                # 2. ì´ë¯¸ì§€ ì¶”ì¶œ
                if shape.shape_type == MSO_SHAPE_TYPE.PICTURE:
                    image_blob = shape.image.blob
                    # Vision LLM ë¶„ì„
                    desc = await analyze_vision_ollama(image_blob, "Describe this chart or image in the presentation slide.")
                    slide_images.append(desc)

            # ìŠ¬ë¼ì´ë“œ ìš”ì•½
            combined_text = "\n".join(slide_text)
            combined_images = "\n".join([f"[Image Analysis]: {img}" for img in slide_images])
            
            slide_content = f"### Slide {i+1}\n**Text:**\n{combined_text}\n\n**Visuals:**\n{combined_images}\n"
            full_text_summary += slide_content
            
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

    return {
        "type": "ppt",
        "filename": filename,
        "summary": f"**PPT Presentation Analysis**\n{full_text_summary}",
        "raw_context": full_text_summary
    }

async def parse_pdf_full(content: bytes, filename: str):
    """PDF ì „ì²´ í˜ì´ì§€ íŒŒì‹±"""
    try:
        # í˜ì´ì§€ ì œí•œ ì—†ì´ ë³€í™˜ (ë©”ëª¨ë¦¬ ì£¼ì˜: ë„ˆë¬´ í¬ë©´ ë‚˜ëˆ ì„œ í•´ì•¼ í•¨)
        # 300dpië¡œ ë³€í™˜
        images = convert_from_bytes(content, dpi=200, fmt='jpeg')
        
        full_text = ""
        preview_image_b64 = None

        print(f"ğŸ“„ PDF Processing: {filename} ({len(images)} pages)")

        for i, img in enumerate(images):
            # ì¸ë„¤ì¼ (ì²«ì¥)
            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_bytes = buffered.getvalue()
            if i == 0:
                preview_image_b64 = base64.b64encode(img_bytes).decode('utf-8')
            
            # Vision Analysis
            page_desc = await analyze_vision_ollama(
                img_bytes, 
                "Transcribe this page into Markdown. Preserve tables and headers."
            )
            full_text += f"\n--- Page {i+1} ---\n{page_desc}\n"

        return {
            "type": "image", # UI í‘œì‹œëŠ” ì´ë¯¸ì§€ íƒ€ì… í™œìš©
            "filename": filename,
            "summary": f"**PDF Full Analysis**\n{full_text}",
            "image_b64": preview_image_b64,
            "raw_context": full_text
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": f"PDF Error: {str(e)}"}

async def parse_spectrum(content: bytes, filename: str):
    """ìŠ¤í™íŠ¸ëŸ¼ CSV/TXT íŒŒì‹± (ê¸°ì¡´ ë¡œì§)"""
    try:
        try:
            df = pd.read_csv(io.BytesIO(content))
        except:
            df = pd.read_csv(io.BytesIO(content), delimiter='\t')
            
        x = df.iloc[:, 0].values
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        
        step = max(1, len(x) // 500)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
        
        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Spectrum Data: {len(peaks)} peaks detected.",
            "chart_data": chart_data,
            "raw_context": f"Spectrum File {filename}. Peaks at indices: {peaks}. Max intensity: {np.max(y)}"
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def parse_image_file(content: bytes, filename: str):
    """ì¼ë°˜ ì´ë¯¸ì§€ (TIF, PNG ë“±)"""
    try:
        # TIF ë“± í˜¸í™˜ì„±ì„ ìœ„í•´ PILë¡œ ì—´ì–´ì„œ JPEGë¡œ ë³€í™˜ í›„ ì „ì†¡
        img = Image.open(io.BytesIO(content)).convert("RGB")
        buffered = io.BytesIO()
        img.save(buffered, format="JPEG")
        img_bytes = buffered.getvalue()
        
        desc = await analyze_vision_ollama(img_bytes, "Analyze this scientific image. Focus on defects, patterns, and anomalies.")
        img_b64 = base64.b64encode(img_bytes).decode('utf-8')
        
        return {
            "type": "image",
            "filename": filename,
            "summary": f"**Image Analysis**\n{desc}",
            "image_b64": img_b64,
            "raw_context": f"Image File {filename} Analysis: {desc}"
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

# --- 3. ë©”ì¸ ë¼ìš°í„° ---

app = FastAPI(title="Professional Analyst")
app.add_middleware(CORSMiddleware, allow_origins=["*"], allow_methods=["*"], allow_headers=["*"])

@app.post("/api/analyze")
async def analyze_orchestrator(
    files: List[UploadFile] = File(...),
    custom_prompt: Optional[str] = Form(""),
    language: str = Form("korean") # 'korean' or 'english'
):
    print(f"ğŸš€ Analyzing {len(files)} files. Language: {language}")
    
    tasks = []
    
    for file in files:
        content = await file.read()
        fname = file.filename.lower()
        
        if fname.endswith(('.xlsx', '.xls')):
            # ì—‘ì…€ì€ ë¹„ë™ê¸° ë˜í¼ê°€ í•„ìš”í•˜ë‚˜ ì—¬ê¸°ì„  await ë°”ë¡œ í˜¸ì¶œ (ë³µì¡ë„ ê°ì†Œ)
            # ê²°ê³¼ê°€ ë¦¬ìŠ¤íŠ¸(ì—¬ëŸ¬ ë¸”ë¡)ë¡œ ì˜´
            excel_results = await parse_excel_advanced(content, file.filename)
            # ë¦¬ìŠ¤íŠ¸ë¥¼ í’€ì–´ì„œ ê²°ê³¼ì— ë„£ê¸° ìœ„í•´ ì„ì‹œ ì €ì¥
            for res in excel_results:
                # Taskë¡œ ê°ì‹¸ëŠ”ê²Œ ì¢‹ìœ¼ë‚˜, êµ¬ì¡°ìƒ ê²°ê³¼ê°’ ì§ì ‘ ì²˜ë¦¬
                pass 
            # (êµ¬ì¡° í†µì¼ì„ ìœ„í•´ ì•„ë˜ gatherì—ì„œëŠ” ì œì™¸í•˜ê³  ë³„ë„ ì²˜ë¦¬ í•„ìš”í•˜ì§€ë§Œ, 
            #  ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ tasksì— ëŒë‹¤ë¡œ ë„£ê±°ë‚˜ ì§ì ‘ ì²˜ë¦¬)
            #  -> ê°œì„ : parse_excel_advanced ìì²´ë¥¼ asyncë¡œ ë§Œë“¤ì—ˆìœ¼ë¯€ë¡œ
            #     Excelì€ ì˜ˆì™¸ì ìœ¼ë¡œ ì—¬ê¸°ì„œ ë°”ë¡œ ì²˜ë¦¬í•´ì„œ results ë¦¬ìŠ¤íŠ¸ì— ë„£ëŠ” ë°©ì‹ ì‚¬ìš©
            pass 

        elif fname.endswith(('.ppt', '.pptx')):
            tasks.append(parse_ppt_advanced(content, file.filename))
            
        elif fname.endswith('.pdf'):
            tasks.append(parse_pdf_full(content, file.filename))
            
        elif fname.endswith(('.csv', '.txt')):
            tasks.append(parse_spectrum(content, file.filename))
            
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.tiff', '.bmp')):
            tasks.append(parse_image_file(content, file.filename))

    # 1. ì—‘ì…€ ì™¸ íŒŒì¼ë“¤ ë³‘ë ¬ ì²˜ë¦¬
    results = await asyncio.gather(*tasks)
    results = list(results) # íŠœí”Œ -> ë¦¬ìŠ¤íŠ¸
    
    # 2. ì—‘ì…€ íŒŒì¼ ì²˜ë¦¬ (íŒŒì¼ í¬ì¸í„°ë¥¼ ë‹¤ì‹œ ì½ì–´ì•¼ í•˜ë¯€ë¡œ ìœ„ ë£¨í”„ì—ì„œ ì½ì€ content ì‚¬ìš© í•„ìš”)
    #    -> ìœ„ ë£¨í”„ êµ¬ì¡°ìƒ contentê°€ ì†Œì‹¤ë˜ë¯€ë¡œ, ì‹¤ì œ êµ¬í˜„ì—ì„  íŒŒì¼ì„ ë©”ëª¨ë¦¬ì— ì½ì–´ë‘ê³  ë¶„ê¸°í•´ì•¼ í•¨.
    #    -> **ìˆ˜ì •ëœ ë¡œì§**: íŒŒì¼ì„ ë¨¼ì € ë‹¤ ì½ì–´ì„œ ë©”ëª¨ë¦¬ì— ë‘ê³  ë¶„ê¸°.
    
    # (ì½”ë“œ ê°„ì†Œí™”ë¥¼ ìœ„í•´ ì¬ì‘ì„± - ì‹¤ì œ ì‹¤í–‰ ë¡œì§)
    final_results = []
    
    # íŒŒì¼ì„ ë‹¤ì‹œ ìˆœíšŒí•˜ë©° ì²˜ë¦¬ (ë©”ëª¨ë¦¬ì— contentê°€ ìˆìœ¼ë¯€ë¡œ ê°€ëŠ¥)
    # ìœ„ tasks ë£¨í”„ë¥¼ ëŒ€ì²´í•©ë‹ˆë‹¤.
    files_content = []
    for file in files:
        await file.seek(0)
        files_content.append({"name": file.filename, "content": await file.read()})
    
    async_tasks = []
    for f in files_content:
        fname = f["name"].lower()
        content = f["content"]
        
        if fname.endswith(('.xlsx', '.xls')):
            # ì—‘ì…€ì€ ê²°ê³¼ê°€ ë¦¬ìŠ¤íŠ¸ë¡œ ë‚˜ì˜´ -> ë³„ë„ ì²˜ë¦¬
            blocks = await parse_excel_advanced(content, f["name"])
            final_results.extend(blocks)
        elif fname.endswith(('.ppt', '.pptx')):
            async_tasks.append(parse_ppt_advanced(content, f["name"]))
        elif fname.endswith('.pdf'):
            async_tasks.append(parse_pdf_full(content, f["name"]))
        elif fname.endswith(('.csv', '.txt')):
            async_tasks.append(parse_spectrum(content, f["name"]))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.tiff', '.bmp')):
            async_tasks.append(parse_image_file(content, f["name"]))

    # ë‚˜ë¨¸ì§€ ë¹„ë™ê¸° ì‘ì—… ì‹¤í–‰
    other_results = await asyncio.gather(*async_tasks)
    final_results.extend(list(other_results))
    
    # --- ì¢…í•© ë¦¬í¬íŠ¸ ìƒì„± (Synthesis) ---
    
    # ì—ëŸ¬ ì œì™¸í•˜ê³  ì»¨í…ìŠ¤íŠ¸ ìˆ˜ì§‘
    valid_data = [r for r in final_results if r.get("type") != "error"]
    
    context_text = ""
    for item in valid_data:
        # raw_contextê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ summary ì‚¬ìš©
        text_content = item.get("raw_context", item.get("summary", ""))
        context_text += f"\n=== Source File: {item['filename']} ===\n{text_content[:5000]}\n" # ë„ˆë¬´ ê¸¸ë©´ ìë¦„

    # ì–¸ì–´ ì„¤ì •
    lang_instruction = "Write the report in **Korean**." if language == 'korean' else "Write the report in **English**."
    
    system_prompt = f"""
    You are a Senior Data Scientist. Synthesize the following multi-modal analysis results into a comprehensive research report.
    
    [Instructions]
    1. {lang_instruction}
    2. Use Markdown tables to summarize numerical data or comparisons.
    3. Interpret the relationship between different files (e.g., Image defects vs Spectrum peaks).
    4. Consider the user's additional request: "{custom_prompt}"
    5. The report structure should include: Executive Summary, Detailed Analysis (per data source), Integrated Discussion, and Conclusion.
    """
    
    final_report = "ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    if context_text:
        try:
            print("ğŸ“ Generating Final Report...")
            res = await asyncio.to_thread(
                ollama_client.chat,
                model=TEXT_MODEL,
                messages=[
                    {'role': 'system', 'content': system_prompt},
                    {'role': 'user', 'content': f"Here is the raw analysis data:\n{context_text}"}
                ]
            )
            final_report = res['message']['content']
        except Exception as e:
            final_report = f"Report Generation Failed: {e}"

    return {
        "results": final_results,
        "final_report": final_report
    }

@app.get("/", response_class=HTMLResponse)
async def serve_index():
    if os.path.exists("index.html"):
        return FileResponse("index.html")
    return "<h1>index.html not found</h1>"

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)

í”„ë¡œí˜ì…”ë„ í”„ë¡ íŠ¸ ì—”ë“œ

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Analyst Pro</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PDF Export Lib -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 8px; text-align: left; }
        .prose th { background-color: #f8fafc; font-weight: 600; }
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                    <i data-lucide="layers" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 tracking-tight">AI Multi-modal Analyst Pro</h1>
                    <p class="text-sm text-slate-500">Excel Blocks â€¢ PPT â€¢ PDF â€¢ Image â€¢ Spectrum Synthesis</p>
                </div>
            </div>
            <div class="flex gap-2">
                <span class="px-3 py-1 bg-white border border-slate-200 rounded-full text-xs font-semibold text-slate-600 shadow-sm flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span> Online
                </span>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Panel: Controls (Col 4) -->
            <div class="lg:col-span-4 space-y-6">
                
                <!-- 1. Upload Zone -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-indigo-500"></i> Files
                    </h2>
                    
                    <div 
                        class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:border-indigo-400 hover:bg-indigo-50/30 transition-all cursor-pointer group"
                        @dragover.prevent
                        @drop.prevent="handleDrop"
                        @click="$refs.fileInput.click()"
                    >
                        <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                        <div class="bg-indigo-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i data-lucide="plus" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <p class="font-semibold text-slate-700">Click or Drag files here</p>
                        <p class="text-xs text-slate-400 mt-1">Supports XLSX, PPTX, PDF, CSV, Images</p>
                    </div>

                    <!-- File List -->
                    <div v-if="files.length > 0" class="mt-4 space-y-2">
                        <div v-for="(file, idx) in files" :key="idx" class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm">
                            <div class="flex items-center gap-3 overflow-hidden">
                                <i :data-lucide="getFileIcon(file.name)" class="w-4 h-4 text-slate-400 flex-shrink-0"></i>
                                <span class="truncate">{{ file.name }}</span>
                            </div>
                            <button @click.stop="removeFile(idx)" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                <!-- 2. Analysis Options -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="sliders" class="w-5 h-5 text-indigo-500"></i> Options
                    </h2>
                    
                    <!-- Language -->
                    <div class="mb-5">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Report Language</label>
                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <button 
                                @click="language = 'korean'"
                                :class="{'bg-white shadow-sm text-indigo-600': language === 'korean', 'text-slate-500': language !== 'korean'}"
                                class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all"
                            >í•œê¸€ (Korean)</button>
                            <button 
                                @click="language = 'english'"
                                :class="{'bg-white shadow-sm text-indigo-600': language === 'english', 'text-slate-500': language !== 'english'}"
                                class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all"
                            >English</button>
                        </div>
                    </div>

                    <!-- Custom Prompt -->
                    <div class="mb-5">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Additional Instructions</label>
                        <textarea 
                            v-model="customPrompt" 
                            class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none resize-none"
                            rows="3"
                            placeholder="ì˜ˆ: '3í˜ì´ì§€ í‘œë¥¼ ì¤‘ì ì ìœ¼ë¡œ ë¶„ì„í•´ì¤˜', 'ê²°ë¡ ì„ ë¨¼ì € ìš”ì•½í•´ì¤˜'..."
                        ></textarea>
                    </div>

                    <!-- Action Button -->
                    <button 
                        @click="analyze" 
                        :disabled="files.length === 0 || isAnalyzing"
                        class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 active:scale-95 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 flex justify-center items-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none"
                    >
                        <div v-if="isAnalyzing" class="loader"></div>
                        <span v-else>Generate Analysis Report</span>
                    </button>
                </div>
            </div>

            <!-- Right Panel: Report (Col 8) -->
            <div class="lg:col-span-8">
                
                <!-- Placeholder -->
                <div v-if="!result && !isAnalyzing" class="h-full min-h-[500px] bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-slate-300">
                    <i data-lucide="file-bar-chart-2" class="w-24 h-24 mb-6 opacity-20"></i>
                    <p class="text-lg font-medium text-slate-400">Ready to Analyze</p>
                    <p class="text-sm mt-2">Upload files and configure options to start.</p>
                </div>

                <!-- Loading State -->
                <div v-if="isAnalyzing" class="h-full min-h-[500px] bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center p-12 text-center">
                    <div class="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
                    <h3 class="text-xl font-bold text-slate-800">Processing Data...</h3>
                    <p class="text-slate-500 mt-2 max-w-md">Parsing complex Excel blocks, scanning PDF/PPT pages, and synthesizing insights with LLM. This may take a moment.</p>
                </div>

                <!-- Report View -->
                <div v-if="result" class="space-y-6 animate-fade-in-up">
                    
                    <!-- Toolbar -->
                    <div class="flex justify-end gap-2">
                        <button @click="downloadPDF" class="px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-lg hover:bg-slate-900 flex items-center gap-2 shadow-md transition-all">
                            <i data-lucide="download"></i> Save as PDF
                        </button>
                    </div>

                    <!-- Report Content (Print Target) -->
                    <div id="report-content" class="bg-white p-10 rounded-2xl shadow-sm border border-slate-100">
                        
                        <!-- Header for PDF -->
                        <div class="border-b border-slate-200 pb-6 mb-8">
                            <h1 class="text-3xl font-bold text-slate-900 mb-2">Comprehensive Analysis Report</h1>
                            <p class="text-slate-500 text-sm">Generated by AI Analyst Pro â€¢ {{ new Date().toLocaleDateString() }}</p>
                        </div>

                        <!-- 1. LLM Final Synthesis -->
                        <section class="mb-12">
                            <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
                                <i data-lucide="sparkles"></i> Executive Synthesis
                            </h2>
                            <div class="prose prose-slate prose-lg max-w-none text-slate-700 leading-relaxed" v-html="renderMarkdown(result.final_report)"></div>
                        </section>

                        <!-- 2. Individual Source Data -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2 border-t pt-8">
                                <i data-lucide="database"></i> Source Data Details
                            </h2>

                            <div v-for="(item, idx) in result.results" :key="idx" class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-100 break-inside-avoid">
                                
                                <!-- Header -->
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="px-2 py-1 bg-white border border-slate-200 rounded text-xs font-bold uppercase text-slate-500">{{ item.type }}</span>
                                    <h3 class="font-bold text-slate-700">{{ item.filename }}</h3>
                                </div>

                                <!-- Content based on Type -->
                                
                                <!-- A. Spectrum / Excel Chart -->
                                <div v-if="item.chart_data && item.chart_data.length > 0" class="mb-4">
                                    <div :id="'chart-' + idx" class="w-full h-64 bg-white rounded border border-slate-200"></div>
                                </div>

                                <!-- B. Image / PDF Preview -->
                                <div v-if="item.image_b64" class="mb-4">
                                    <img :src="'data:image/jpeg;base64,' + item.image_b64" class="max-h-80 rounded border border-slate-200 shadow-sm mx-auto">
                                </div>

                                <!-- Summary Text -->
                                <div class="text-sm text-slate-600 bg-white p-4 rounded border border-slate-200">
                                    <div class="prose prose-sm max-w-none" v-html="renderMarkdown(item.summary)"></div>
                                </div>
                            </div>
                        </section>
                    </div>

                </div>

            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);
                const customPrompt = ref("");
                const language = ref("korean");

                const handleFileSelect = (e) => files.value.push(...Array.from(e.target.files));
                const handleDrop = (e) => files.value.push(...Array.from(e.dataTransfer.files));
                const removeFile = (i) => files.value.splice(i, 1);

                const getFileIcon = (name) => {
                    if (name.endsWith('.pdf')) return 'file-text';
                    if (name.match(/\.(xlsx|xls|csv)$/)) return 'sheet';
                    if (name.match(/\.(ppt|pptx)$/)) return 'presentation';
                    if (name.match(/\.(png|jpg|jpeg|tif|tiff)$/)) return 'image';
                    return 'file';
                }

                const renderMarkdown = (text) => marked.parse(text || '');

                const analyze = async () => {
                    isAnalyzing.value = true;
                    result.value = null;
                    
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));
                    formData.append('custom_prompt', customPrompt.value);
                    formData.append('language', language.value);

                    try {
                        const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                        const data = await res.json();
                        result.value = data;
                        
                        await nextTick();
                        drawCharts(data.results);
                        lucide.createIcons();
                    } catch (e) {
                        alert("Error: " + e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.chart_data && item.chart_data.length > 0) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: { color: '#4f46e5', width: 2 },
                                type: 'scatter'
                            };
                            const layout = {
                                margin: { t: 10, b: 30, l: 40, r: 10 },
                                xaxis: { zeroline: false },
                                yaxis: { zeroline: false },
                                paper_bgcolor: 'rgba(0,0,0,0)',
                                plot_bgcolor: 'rgba(0,0,0,0)'
                            };
                            Plotly.newPlot('chart-' + idx, [trace], layout, {displayModeBar: false});
                        }
                    });
                };

                const downloadPDF = () => {
                    const element = document.getElementById('report-content');
                    const opt = {
                        margin: 10,
                        filename: 'AI_Analysis_Report.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save();
                };

                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result, customPrompt, language,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown, getFileIcon, downloadPDF
                };
            }
        }).mount('#app');
    </script>
</body>
</html>

ìˆ˜ì •ëœ ì›¹ í˜ì´ì§€.

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced AI Analyst Pro (Fixed)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ë§ */
        .prose table { width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; }
        .prose th, .prose td { border: 1px solid #e2e8f0; padding: 8px 12px; text-align: left; }
        .prose th { background-color: #f1f5f9; font-weight: 700; color: #334155; }
        .prose tr:nth-child(even) { background-color: #f8fafc; }
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #4f46e5; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-200">
                    <i data-lucide="layers" class="w-8 h-8 text-white"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900 tracking-tight">AI Multi-modal Analyst Pro</h1>
                    <p class="text-sm text-slate-500">Fixed Image Rendering â€¢ Secure Mode</p>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Panel: Controls -->
            <div class="lg:col-span-4 space-y-6">
                <!-- 1. Upload Zone -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="upload-cloud" class="w-5 h-5 text-indigo-500"></i> Files
                    </h2>
                    
                    <div 
                        class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center hover:border-indigo-400 hover:bg-indigo-50/30 transition-all cursor-pointer group"
                        @dragover.prevent
                        @drop.prevent="handleDrop"
                        @click="$refs.fileInput.click()"
                    >
                        <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                        <div class="bg-indigo-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 group-hover:scale-110 transition-transform">
                            <i data-lucide="plus" class="w-6 h-6 text-indigo-600"></i>
                        </div>
                        <p class="font-semibold text-slate-700">Click or Drag files here</p>
                        <p class="text-xs text-slate-400 mt-1">XLSX, PPTX, PDF, CSV, Images</p>
                    </div>

                    <div v-if="files.length > 0" class="mt-4 space-y-2">
                        <div v-for="(file, idx) in files" :key="idx" class="flex items-center justify-between p-3 bg-slate-50 rounded-lg border border-slate-100 text-sm">
                            <span class="truncate max-w-[200px]">{{ file.name }}</span>
                            <button @click.stop="removeFile(idx)" class="text-slate-400 hover:text-red-500"><i data-lucide="x" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>

                <!-- 2. Options -->
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-slate-800">
                        <i data-lucide="sliders" class="w-5 h-5 text-indigo-500"></i> Analysis Options
                    </h2>
                    
                    <!-- Language -->
                    <div class="mb-5">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Report Language</label>
                        <div class="flex bg-slate-100 p-1 rounded-lg">
                            <button @click="language = 'korean'" :class="language === 'korean' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all">í•œê¸€</button>
                            <button @click="language = 'english'" :class="language === 'english' ? 'bg-white shadow-sm text-indigo-600' : 'text-slate-500'" class="flex-1 py-1.5 text-sm font-medium rounded-md transition-all">English</button>
                        </div>
                    </div>

                    <!-- Custom Prompt -->
                    <div class="mb-5">
                        <label class="block text-xs font-semibold text-slate-500 uppercase mb-2">Instructions</label>
                        <textarea v-model="customPrompt" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-lg text-sm resize-none focus:outline-indigo-500" rows="3" placeholder="ì˜ˆ: ê²°ë¡  ìœ„ì£¼ë¡œ ìš”ì•½í•´ì¤˜"></textarea>
                    </div>

                    <button @click="analyze" :disabled="files.length === 0 || isAnalyzing" class="w-full py-3.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 flex justify-center items-center gap-2 transition-all disabled:opacity-50">
                        <div v-if="isAnalyzing" class="loader"></div>
                        <span v-else>Generate Report</span>
                    </button>
                </div>
            </div>

            <!-- Right Panel: Report -->
            <div class="lg:col-span-8">
                
                <!-- Placeholder -->
                <div v-if="!result && !isAnalyzing" class="h-full min-h-[500px] bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center text-slate-300">
                    <i data-lucide="file-bar-chart-2" class="w-24 h-24 mb-6 opacity-20"></i>
                    <p class="text-lg font-medium text-slate-400">Ready to Analyze</p>
                </div>

                <!-- Loading -->
                <div v-if="isAnalyzing" class="h-full min-h-[500px] bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col items-center justify-center p-12 text-center">
                    <div class="w-16 h-16 border-4 border-indigo-100 border-t-indigo-600 rounded-full animate-spin mb-6"></div>
                    <h3 class="text-xl font-bold text-slate-800">Processing...</h3>
                    <p class="text-slate-500 mt-2">Parsing Excel Blocks, Scanning PDF/PPT, Generating Charts...</p>
                </div>

                <!-- Result View -->
                <div v-if="result" class="space-y-6 animate-fade-in-up">
                    <div class="flex justify-end gap-2">
                        <button @click="downloadPDF" class="px-4 py-2 bg-slate-800 text-white text-sm font-medium rounded-lg hover:bg-slate-900 flex items-center gap-2 shadow-md">
                            <i data-lucide="download"></i> Save as PDF
                        </button>
                    </div>

                    <div id="report-content" class="bg-white p-10 rounded-2xl shadow-sm border border-slate-100">
                        <!-- Header -->
                        <div class="border-b border-slate-200 pb-6 mb-8">
                            <h1 class="text-3xl font-bold text-slate-900 mb-2">Comprehensive Analysis Report</h1>
                            <p class="text-slate-500 text-sm">Generated by AI Analyst Pro â€¢ {{ new Date().toLocaleDateString() }}</p>
                        </div>

                        <!-- 1. Executive Summary (Text) -->
                        <section class="mb-12">
                            <h2 class="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
                                <i data-lucide="sparkles"></i> Executive Synthesis
                            </h2>
                            <!-- AI Text Output -->
                            <div class="prose prose-slate prose-lg max-w-none text-slate-700 leading-relaxed" v-html="renderMarkdown(result.final_report)"></div>
                        </section>

                        <!-- 2. Data Visualizations & Evidence (Real Images/Charts) -->
                        <section>
                            <h2 class="text-xl font-bold text-slate-800 mb-6 flex items-center gap-2 border-t pt-8">
                                <i data-lucide="images"></i> Visual Evidence & Data
                            </h2>

                            <div v-for="(item, idx) in result.results" :key="idx" class="mb-8 p-6 bg-slate-50 rounded-xl border border-slate-100 break-inside-avoid">
                                <div class="flex items-center gap-2 mb-4">
                                    <span class="px-2 py-1 bg-white border border-slate-200 rounded text-xs font-bold uppercase text-slate-500">{{ item.type }}</span>
                                    <h3 class="font-bold text-slate-700">{{ item.filename }}</h3>
                                </div>

                                <!-- A. Plotly Charts (Spectrum / Excel) -->
                                <div v-if="item.chart_data && item.chart_data.length > 0" class="mb-4 bg-white p-2 rounded border border-slate-200">
                                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2 ml-2">Data Plot</h4>
                                    <div :id="'chart-' + idx" class="w-full h-64"></div>
                                </div>

                                <!-- B. Extracted Images (PDF Page / PPT Slide / Raw Image) -->
                                <div v-if="item.image_b64" class="mb-4">
                                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Source Preview</h4>
                                    <!-- Base64 Image Rendering -->
                                    <img :src="'data:image/jpeg;base64,' + item.image_b64" 
                                         class="max-h-96 rounded border border-slate-200 shadow-sm mx-auto object-contain bg-white"
                                         @error="handleImageError">
                                </div>

                                <!-- Summary Text -->
                                <div class="text-sm text-slate-600 bg-white p-4 rounded border border-slate-200 mt-3">
                                    <div class="prose prose-sm max-w-none" v-html="renderMarkdown(item.summary)"></div>
                                </div>
                            </div>
                        </section>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);
                const customPrompt = ref("");
                const language = ref("korean");

                // --- 1. Markdown ì„¤ì • (ì¤‘ìš”: ì´ë¯¸ì§€ ë Œë”ë§ ì°¨ë‹¨) ---
                const renderer = new marked.Renderer();
                // AIê°€ ìƒì„±í•œ í…ìŠ¤íŠ¸ ë‚´ì˜ ì´ë¯¸ì§€ëŠ” ë³´ì•ˆ ë¬¸ì œ(mwg-internal)ë¥¼ ì¼ìœ¼í‚¤ë¯€ë¡œ ë¹ˆ ë¬¸ìì—´ë¡œ ëŒ€ì²´
                renderer.image = function(href, title, text) {
                    return ''; 
                };
                marked.use({ renderer });

                const handleFileSelect = (e) => files.value.push(...Array.from(e.target.files));
                const handleDrop = (e) => files.value.push(...Array.from(e.dataTransfer.files));
                const removeFile = (i) => files.value.splice(i, 1);
                const handleImageError = (e) => { e.target.style.display = 'none'; }; // ê¹¨ì§„ ì´ë¯¸ì§€ ìˆ¨ê¹€

                const renderMarkdown = (text) => marked.parse(text || '');

                const analyze = async () => {
                    isAnalyzing.value = true;
                    result.value = null;
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));
                    formData.append('custom_prompt', customPrompt.value);
                    formData.append('language', language.value);

                    try {
                        const res = await fetch('/api/analyze', { method: 'POST', body: formData });
                        const data = await res.json();
                        result.value = data;
                        await nextTick();
                        drawCharts(data.results);
                        lucide.createIcons();
                    } catch (e) {
                        alert("Error: " + e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.chart_data && item.chart_data.length > 0) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: { color: '#4f46e5', width: 2 }
                            };
                            const layout = {
                                margin: { t: 20, b: 30, l: 40, r: 20 },
                                xaxis: { title: 'Index / Wavelength' },
                                yaxis: { title: 'Value' },
                                showlegend: false
                            };
                            Plotly.newPlot('chart-' + idx, [trace], layout, {displayModeBar: false});
                        }
                    });
                };

                const downloadPDF = () => {
                    const element = document.getElementById('report-content');
                    const opt = {
                        margin: 10,
                        filename: 'AI_Report.pdf',
                        image: { type: 'jpeg', quality: 0.98 },
                        html2canvas: { scale: 2 },
                        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                    };
                    html2pdf().set(opt).from(element).save();
                };

                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result, customPrompt, language,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown, downloadPDF, handleImageError
                };
            }
        }).mount('#app');
    </script>
</body>
</html>



