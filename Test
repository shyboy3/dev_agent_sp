index.html

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A6000 AI Lab Analyst</title>
    
    <!-- 1. 스타일 도구 (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. 반응형 로직 도구 (Vue.js 3) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 3. 차트 도구 (Plotly.js) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- 4. 마크다운 렌더러 (Marked) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 5. 아이콘 (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="microscope" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">A6000 Multi-modal Analyst</h1>
                    <p class="text-sm text-slate-500">Dual GPU Powered Local Analysis System</p>
                </div>
            </div>
            <div class="flex gap-2 text-xs font-mono bg-slate-200 px-3 py-1 rounded">
                <span class="text-green-600">● System Ready</span>
                <span>|</span>
                <span>GPU: A6000 x2</span>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left: Upload & Status -->
            <div class="space-y-6">
                <!-- Dropzone -->
                <div 
                    class="bg-white p-8 rounded-xl shadow-sm border-2 border-dashed border-indigo-100 hover:border-indigo-400 transition-colors text-center cursor-pointer"
                    @dragover.prevent
                    @drop.prevent="handleDrop"
                    @click="$refs.fileInput.click()"
                >
                    <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                    <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-indigo-300 mb-4"></i>
                    <p class="font-medium text-slate-700">파일을 드래그하거나 클릭하세요</p>
                    <p class="text-xs text-slate-400 mt-2">CSV, PNG, JPG, PDF 지원</p>
                </div>

                <!-- File List -->
                <div v-if="files.length > 0" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-sm">
                        업로드 대기 목록 ({{ files.length }})
                    </div>
                    <ul class="max-h-60 overflow-y-auto">
                        <li v-for="(file, index) in files" :key="index" class="p-3 border-b last:border-0 flex justify-between items-center text-sm">
                            <span class="truncate max-w-[200px]">{{ file.name }}</span>
                            <button @click.stop="removeFile(index)" class="text-red-400 hover:text-red-600">×</button>
                        </li>
                    </ul>
                    <div class="p-4">
                        <button 
                            @click="analyze" 
                            :disabled="isAnalyzing"
                            class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span v-if="isAnalyzing" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></span>
                            {{ isAnalyzing ? '분석 중...' : '종합 분석 실행' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Initial State -->
                <div v-if="!result && !isAnalyzing" class="h-96 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center text-slate-400">
                    <i data-lucide="bar-chart-2" class="w-16 h-16 mb-4 opacity-50"></i>
                    <p>데이터를 업로드하면 분석 결과가 여기에 표시됩니다.</p>
                </div>

                <!-- Analysis Results -->
                <div v-if="result" class="space-y-6 animate-fade-in">
                    
                    <!-- 1. Final Report -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-800">
                            <i data-lucide="file-text"></i> 종합 리포트
                        </h2>
                        <div class="prose prose-slate max-w-none" v-html="renderMarkdown(result.final_report)"></div>
                    </div>

                    <!-- 2. Individual Results -->
                    <div v-for="(item, idx) in result.results" :key="idx" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        
                        <!-- Spectrum Type -->
                        <div v-if="item.type === 'spectrum'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="activity"></i> {{ item.filename }}
                            </h3>
                            <p class="text-sm text-slate-500 mb-4">{{ item.summary }}</p>
                            <!-- Chart Container -->
                            <div :id="'chart-' + idx" class="w-full h-64 bg-slate-50 rounded"></div>
                        </div>

                        <!-- Image Type -->
                        <div v-if="item.type === 'image'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="image"></i> {{ item.filename }}
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <img :src="'data:image/jpeg;base64,' + item.image_b64" class="rounded border border-slate-200 max-h-64 object-contain">
                                <div class="text-sm text-slate-600 bg-slate-50 p-4 rounded">
                                    <strong>AI Analysis:</strong><br>
                                    {{ item.summary }}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);

                const handleFileSelect = (e) => {
                    files.value.push(...Array.from(e.target.files));
                };

                const handleDrop = (e) => {
                    files.value.push(...Array.from(e.dataTransfer.files));
                };

                const removeFile = (index) => {
                    files.value.splice(index, 1);
                };

                const renderMarkdown = (text) => {
                    return marked.parse(text || '');
                };

                const analyze = async () => {
                    if (files.value.length === 0) return;
                    
                    isAnalyzing.value = true;
                    result.value = null;
                    
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));

                    try {
                        const response = await fetch('/api/analyze', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        result.value = data;

                        // Wait for DOM update then draw charts
                        await nextTick();
                        drawCharts(data.results);
                        
                        // Re-initialize icons
                        lucide.createIcons();

                    } catch (e) {
                        alert("분석 중 오류 발생: " + e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.type === 'spectrum' && item.chart_data) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: {color: '#4f46e5'},
                                name: 'Signal'
                            };
                            
                            // Peaks
                            const peaks = {
                                x: item.peaks.map(p => p.x),
                                y: item.peaks.map(p => p.y),
                                mode: 'markers',
                                marker: {color: 'red', size: 8},
                                name: 'Peaks'
                            };

                            const layout = {
                                margin: {t: 20, b: 40, l: 40, r: 20},
                                showlegend: false,
                                xaxis: {title: 'Wavelength/Index'},
                                yaxis: {title: 'Intensity'}
                            };

                            Plotly.newPlot('chart-' + idx, [trace, peaks], layout);
                        }
                    });
                };

                // Initialize icons on mount
                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>



main.py

import os
import json
import asyncio
import base64
import io
from typing import List, Dict, Any

from fastapi import FastAPI, UploadFile, File, Request
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.staticfiles import StaticFiles
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
import cv2
import ollama

# --- 설정 및 모델 ---
app = FastAPI(title="A6000 AI Analyst")

# CORS 설정 (혹시 모를 외부 접속 대비)
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 분석 엔진 (축약된 핵심 로직) ---

async def analyze_spectrum(content: bytes, filename: str):
    """스펙트럼 분석 (SciPy + LLM)"""
    try:
        # 1. 데이터 로드 (CSV/TXT 가정)
        try:
            df = pd.read_csv(io.BytesIO(content))
        except:
            df = pd.read_csv(io.BytesIO(content), delimiter='\t')
            
        # 데이터가 숫자가 아닌 경우 등 예외처리 필요하지만 데모를 위해 생략
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        x = df.iloc[:, 0].values if df.shape[1] > 1 else np.arange(len(y))
        
        # 2. 피크 검출
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        peak_vals = [{"x": float(x[p]), "y": float(y[p])} for p in peaks]
        
        # 3. 차트용 데이터 (다운샘플링하여 전송량 감소)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::5], y[::5])]

        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Detected {len(peaks)} peaks.",
            "chart_data": chart_data,
            "peaks": peak_vals
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def analyze_image(content: bytes, filename: str):
    """이미지 분석 (Vision LLM)"""
    try:
        # Vision LLM (Llava or Qwen) 호출
        # A6000 환경이므로 base64 변환 후 로컬 Ollama 호출
        img_b64 = base64.b64encode(content).decode('utf-8')
        
        # 실제 환경에서는 'llava' 또는 'qwen2-vl' 모델명 사용
        response = await asyncio.to_thread(
            ollama.chat,
            model="llava", 
            messages=[{
                'role': 'user',
                'content': "Describe this scientific image in detail. Identify defects or key features.",
                'images': [img_b64]
            }]
        )
        
        return {
            "type": "image",
            "filename": filename,
            "summary": response['message']['content'],
            "image_b64": img_b64 # 화면 표시용
        }
    except Exception as e:
        # 모델이 없을 경우 대비한 Mock 응답
        return {"type": "image", "filename": filename, "summary": f"Image analyzed (Mock: Ensure ollama is running). Error: {e}", "image_b64": img_b64}

# --- 라우터 ---

@app.post("/api/analyze")
async def analyze_files(files: List[UploadFile] = File(...)):
    """다중 파일 업로드 및 비동기 병렬 분석"""
    tasks = []
    for file in files:
        content = await file.read()
        fname = file.filename.lower()
        
        if fname.endswith(('.csv', '.txt', '.xlsx')):
            tasks.append(analyze_spectrum(content, file.filename))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif')):
            tasks.append(analyze_image(content, file.filename))
        # PDF/PPT 로직 추가 가능
            
    results = await asyncio.gather(*tasks)
    
    # 종합 리포트 생성 (Text LLM)
    context = "\n".join([f"- {r.get('filename')}: {r.get('summary')}" for r in results if 'summary' in r])
    
    final_report = "종합 분석을 진행할 수 없습니다. (Ollama 연결 실패)"
    try:
        res = await asyncio.to_thread(
            ollama.chat,
            model="llama3",
            messages=[{'role': 'user', 'content': f"Analyze these scientific findings into a report:\n{context}"}]
        )
        final_report = res['message']['content']
    except:
        pass

    return {"results": results, "final_report": final_report}

# ★ 핵심: 루트 경로 접속 시 HTML 파일 서빙
@app.get("/", response_class=HTMLResponse)
async def serve_frontend():
    # 같은 폴더에 있는 index.html을 읽어서 반환
    if os.path.exists("index.html"):
        return FileResponse("index.html")
    return "index.html 파일을 찾을 수 없습니다."

if __name__ == "__main__":
    import uvicorn
    # A6000 서버 IP로 접속 가능하게 host='0.0.0.0' 설정
    uvicorn.run(app, host="0.0.0.0", port=8000)

