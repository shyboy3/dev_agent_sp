index.html

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A6000 AI Lab Analyst</title>
    
    <!-- 1. ìŠ¤íƒ€ì¼ ë„êµ¬ (Tailwind CSS) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. ë°˜ì‘í˜• ë¡œì§ ë„êµ¬ (Vue.js 3) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 3. ì°¨íŠ¸ ë„êµ¬ (Plotly.js) -->
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <!-- 4. ë§ˆí¬ë‹¤ìš´ ë Œë”ëŸ¬ (Marked) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 5. ì•„ì´ì½˜ (Lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        .loader {
            border-top-color: #3498db;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans">
    <div id="app" class="min-h-screen p-6">
        
        <!-- Header -->
        <header class="max-w-7xl mx-auto mb-8 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i data-lucide="microscope" class="w-8 h-8"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">A6000 Multi-modal Analyst</h1>
                    <p class="text-sm text-slate-500">Dual GPU Powered Local Analysis System</p>
                </div>
            </div>
            <div class="flex gap-2 text-xs font-mono bg-slate-200 px-3 py-1 rounded">
                <span class="text-green-600">â— System Ready</span>
                <span>|</span>
                <span>GPU: A6000 x2</span>
            </div>
        </header>

        <main class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left: Upload & Status -->
            <div class="space-y-6">
                <!-- Dropzone -->
                <div 
                    class="bg-white p-8 rounded-xl shadow-sm border-2 border-dashed border-indigo-100 hover:border-indigo-400 transition-colors text-center cursor-pointer"
                    @dragover.prevent
                    @drop.prevent="handleDrop"
                    @click="$refs.fileInput.click()"
                >
                    <input type="file" ref="fileInput" multiple class="hidden" @change="handleFileSelect">
                    <i data-lucide="upload-cloud" class="w-12 h-12 mx-auto text-indigo-300 mb-4"></i>
                    <p class="font-medium text-slate-700">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì„¸ìš”</p>
                    <p class="text-xs text-slate-400 mt-2">CSV, PNG, JPG, PDF ì§€ì›</p>
                </div>

                <!-- File List -->
                <div v-if="files.length > 0" class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="p-4 bg-slate-50 border-b border-slate-100 font-semibold text-sm">
                        ì—…ë¡œë“œ ëŒ€ê¸° ëª©ë¡ ({{ files.length }})
                    </div>
                    <ul class="max-h-60 overflow-y-auto">
                        <li v-for="(file, index) in files" :key="index" class="p-3 border-b last:border-0 flex justify-between items-center text-sm">
                            <span class="truncate max-w-[200px]">{{ file.name }}</span>
                            <button @click.stop="removeFile(index)" class="text-red-400 hover:text-red-600">Ã—</button>
                        </li>
                    </ul>
                    <div class="p-4">
                        <button 
                            @click="analyze" 
                            :disabled="isAnalyzing"
                            class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-bold flex justify-center items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <span v-if="isAnalyzing" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5"></span>
                            {{ isAnalyzing ? 'ë¶„ì„ ì¤‘...' : 'ì¢…í•© ë¶„ì„ ì‹¤í–‰' }}
                        </button>
                    </div>
                </div>
            </div>

            <!-- Right: Results -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Initial State -->
                <div v-if="!result && !isAnalyzing" class="h-96 bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col items-center justify-center text-slate-400">
                    <i data-lucide="bar-chart-2" class="w-16 h-16 mb-4 opacity-50"></i>
                    <p>ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
                </div>

                <!-- Analysis Results -->
                <div v-if="result" class="space-y-6 animate-fade-in">
                    
                    <!-- 1. Final Report -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2 text-indigo-800">
                            <i data-lucide="file-text"></i> ì¢…í•© ë¦¬í¬íŠ¸
                        </h2>
                        <div class="prose prose-slate max-w-none" v-html="renderMarkdown(result.final_report)"></div>
                    </div>

                    <!-- 2. Individual Results -->
                    <div v-for="(item, idx) in result.results" :key="idx" class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        
                        <!-- Spectrum Type -->
                        <div v-if="item.type === 'spectrum'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="activity"></i> {{ item.filename }}
                            </h3>
                            <p class="text-sm text-slate-500 mb-4">{{ item.summary }}</p>
                            <!-- Chart Container -->
                            <div :id="'chart-' + idx" class="w-full h-64 bg-slate-50 rounded"></div>
                        </div>

                        <!-- Image Type -->
                        <div v-if="item.type === 'image'">
                            <h3 class="font-bold text-slate-700 mb-2 flex items-center gap-2">
                                <i data-lucide="image"></i> {{ item.filename }}
                            </h3>
                            <div class="grid grid-cols-2 gap-4">
                                <img :src="'data:image/jpeg;base64,' + item.image_b64" class="rounded border border-slate-200 max-h-64 object-contain">
                                <div class="text-sm text-slate-600 bg-slate-50 p-4 rounded">
                                    <strong>AI Analysis:</strong><br>
                                    {{ item.summary }}
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const files = ref([]);
                const isAnalyzing = ref(false);
                const result = ref(null);

                const handleFileSelect = (e) => {
                    files.value.push(...Array.from(e.target.files));
                };

                const handleDrop = (e) => {
                    files.value.push(...Array.from(e.dataTransfer.files));
                };

                const removeFile = (index) => {
                    files.value.splice(index, 1);
                };

                const renderMarkdown = (text) => {
                    return marked.parse(text || '');
                };

                const analyze = async () => {
                    if (files.value.length === 0) return;
                    
                    isAnalyzing.value = true;
                    result.value = null;
                    
                    const formData = new FormData();
                    files.value.forEach(f => formData.append('files', f));

                    try {
                        const response = await fetch('/api/analyze', {
                            method: 'POST',
                            body: formData
                        });
                        const data = await response.json();
                        result.value = data;

                        // Wait for DOM update then draw charts
                        await nextTick();
                        drawCharts(data.results);
                        
                        // Re-initialize icons
                        lucide.createIcons();

                    } catch (e) {
                        alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + e);
                    } finally {
                        isAnalyzing.value = false;
                    }
                };

                const drawCharts = (results) => {
                    results.forEach((item, idx) => {
                        if (item.type === 'spectrum' && item.chart_data) {
                            const trace = {
                                x: item.chart_data.map(d => d.x),
                                y: item.chart_data.map(d => d.y),
                                mode: 'lines',
                                line: {color: '#4f46e5'},
                                name: 'Signal'
                            };
                            
                            // Peaks
                            const peaks = {
                                x: item.peaks.map(p => p.x),
                                y: item.peaks.map(p => p.y),
                                mode: 'markers',
                                marker: {color: 'red', size: 8},
                                name: 'Peaks'
                            };

                            const layout = {
                                margin: {t: 20, b: 40, l: 40, r: 20},
                                showlegend: false,
                                xaxis: {title: 'Wavelength/Index'},
                                yaxis: {title: 'Intensity'}
                            };

                            Plotly.newPlot('chart-' + idx, [trace, peaks], layout);
                        }
                    });
                };

                // Initialize icons on mount
                setTimeout(() => lucide.createIcons(), 100);

                return {
                    files, isAnalyzing, result,
                    handleFileSelect, handleDrop, removeFile, analyze, renderMarkdown
                };
            }
        }).mount('#app');
    </script>
</body>
</html>



main.py

import os
import io
import asyncio
import base64
import json
from typing import List, Dict, Any
from contextlib import asynccontextmanager

from fastapi import FastAPI, UploadFile, File
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware

import pandas as pd
import numpy as np
from scipy.signal import find_peaks
import cv2
from ollama import Client 
from PIL import Image
from pdf2image import convert_from_bytes

# --- 0. ì‚¬ìš©ì í™˜ê²½ ì„¤ì • (User Config) ---

# 1. Ollama ì£¼ì†Œ (ìœˆë„ìš° í™˜ê²½ ê³ ë ¤ ëª…ì‹œì  ì§€ì •)
OLLAMA_HOST = "http://127.0.0.1:11434"

# 2. ì‚¬ìš©í•  ëª¨ë¸ ì´ë¦„ (ollama list ëª…ë ¹ì–´ë¡œ í™•ì¸ëœ ì´ë¦„ì´ì–´ì•¼ í•¨)
# ì‚¬ìš©ì ìš”ì²­ ëª¨ë¸: qwen3-vl:30b-a3b-instruct
VISION_MODEL = "qwen3-vl:30b-a3b-instruct"  
TEXT_MODEL = "llama3:70b"  # ì¢…í•© ë¦¬í¬íŠ¸ìš© (ì—†ìœ¼ë©´ llama3ë¡œ ë³€ê²½)

# í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
ollama_client = Client(host=OLLAMA_HOST)

# --- 1. ì„œë²„ ìˆ˜ëª…ì£¼ê¸° ê´€ë¦¬ ---
@asynccontextmanager
async def lifespan(app: FastAPI):
    print(f"ğŸš€ Starting A6000 Analysis Server (Ollama Mode)")
    print(f"ğŸ¯ Vision Model: {VISION_MODEL}")
    print(f"ğŸ¯ Text Model:   {TEXT_MODEL}")
    
    # ì—°ê²° í…ŒìŠ¤íŠ¸
    try:
        print(f"ğŸ“¡ Connecting to Ollama at {OLLAMA_HOST}...")
        models = ollama_client.list()
        
        # ëª¨ë¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ì‹¤í–‰ì€ ê³„ì†í•¨)
        installed_models = [m['name'] for m in models['models']]
        if VISION_MODEL not in installed_models:
            print(f"âš ï¸ Warning: Vision model '{VISION_MODEL}' not found in 'ollama list'.")
            print(f"   (It might download automatically upon first request, or check the name.)")
        else:
            print(f"âœ… Vision Model '{VISION_MODEL}' is ready.")
            
    except Exception as e:
        print(f"âŒ Error connecting to Ollama: {e}")
        print("   Please ensure 'ollama serve' is running!")
    
    yield
    print("ğŸ‘‹ Shutting down server...")

app = FastAPI(title="Ollama Native Analyst", lifespan=lifespan)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- 2. ë¶„ì„ í•¨ìˆ˜ë“¤ (Ollama API í™œìš©) ---

async def analyze_with_vision_model(image_bytes: bytes, prompt: str) -> str:
    """ì´ë¯¸ì§€ë¥¼ Base64ë¡œ ë³€í™˜í•˜ì—¬ Ollama Vision ëª¨ë¸ì—ê²Œ ì „ì†¡"""
    try:
        # Base64 ì¸ì½”ë”©
        img_b64 = base64.b64encode(image_bytes).decode('utf-8')
        
        # ë¹„ë™ê¸° ì‹¤í–‰ì„ ìœ„í•´ to_thread ì‚¬ìš©
        response = await asyncio.to_thread(
            ollama_client.chat,
            model=VISION_MODEL,
            messages=[{
                'role': 'user',
                'content': prompt,
                'images': [img_b64]
            }]
        )
        return response['message']['content']
    except Exception as e:
        return f"[Vision AI Error] {str(e)}"

async def analyze_pdf(content: bytes, filename: str):
    """PDF -> Image -> Ollama Vision (Page by Page)"""
    try:
        # Popplerë¥¼ ì´ìš©í•´ PDFë¥¼ ì´ë¯¸ì§€ë¡œ ë³€í™˜
        # (Windows í™˜ê²½ë³€ìˆ˜ PATHì— poppler/binì´ ìˆì–´ì•¼ í•¨)
        images = convert_from_bytes(content, first_page=1, last_page=3, fmt='jpeg')
        
        full_text = ""
        preview_image_b64 = None

        print(f"ğŸ“„ Processing PDF: {filename} ({len(images)} pages sample)")

        for i, img in enumerate(images):
            # ì²« í˜ì´ì§€ëŠ” ì¸ë„¤ì¼ìš©ìœ¼ë¡œ ì €ì¥
            buffered = io.BytesIO()
            img.save(buffered, format="JPEG")
            img_bytes = buffered.getvalue()
            
            if i == 0:
                preview_image_b64 = base64.b64encode(img_bytes).decode('utf-8')

            # Vision AI ë¶„ì„ ìš”ì²­
            print(f"   Analyzing Page {i+1} with {VISION_MODEL}...")
            page_content = await analyze_with_vision_model(
                img_bytes, 
                "Transcribe this page into Markdown format. Keep tables and headers structurally correct. Do not summarize, just extract."
            )
            full_text += f"\n--- Page {i+1} ---\n{page_content}\n"

        return {
            "type": "image", # í”„ë¡ íŠ¸ì—”ë“œ í˜¸í™˜ì„±ì„ ìœ„í•´ image íƒ€ì… ì‚¬ìš©
            "filename": filename,
            "summary": f"**PDF Analysis ({VISION_MODEL})**\n\n{full_text}",
            "image_b64": preview_image_b64
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": f"PDF Error: {str(e)} (Check Poppler installed?)"}

async def analyze_image(content: bytes, filename: str):
    """ì¼ë°˜ ì´ë¯¸ì§€ ë¶„ì„"""
    try:
        img_b64 = base64.b64encode(content).decode('utf-8')
        
        print(f"ğŸ–¼ï¸ Analyzing Image: {filename}")
        description = await analyze_with_vision_model(
            content, 
            "Analyze this scientific image in detail. Identify defects, patterns, or key features."
        )
        
        return {
            "type": "image",
            "filename": filename,
            "summary": description,
            "image_b64": img_b64
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

async def analyze_spectrum(content: bytes, filename: str):
    """ìŠ¤í™íŠ¸ëŸ¼ ë¶„ì„ (ê¸°ì¡´ SciPy ë¡œì§)"""
    try:
        try:
            df = pd.read_csv(io.BytesIO(content))
        except:
            df = pd.read_csv(io.BytesIO(content), delimiter='\t')
            
        x = df.iloc[:, 0].values
        y = df.iloc[:, 1].values if df.shape[1] > 1 else df.iloc[:, 0].values
        
        peaks, _ = find_peaks(y, height=np.mean(y), distance=20)
        
        step = max(1, len(x) // 1000)
        chart_data = [{"x": float(xi), "y": float(yi)} for xi, yi in zip(x[::step], y[::step])]
        peak_vals = [{"x": float(x[p]), "y": float(y[p])} for p in peaks]

        return {
            "type": "spectrum",
            "filename": filename,
            "summary": f"Detected {len(peaks)} major peaks via Signal Processing.",
            "chart_data": chart_data,
            "peaks": peak_vals
        }
    except Exception as e:
        return {"type": "error", "filename": filename, "msg": str(e)}

# --- 3. ë¼ìš°íŒ… ë° ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜ ---

@app.post("/api/analyze")
async def analyze_orchestrator(files: List[UploadFile] = File(...)):
    tasks = []
    
    for file in files:
        content = await file.read()
        fname = file.filename.lower()
        
        if fname.endswith('.pdf'):
            tasks.append(analyze_pdf(content, file.filename))
        elif fname.endswith(('.csv', '.txt', '.tsv')):
            tasks.append(analyze_spectrum(content, file.filename))
        elif fname.endswith(('.png', '.jpg', '.jpeg', '.tif', '.bmp')):
            tasks.append(analyze_image(content, file.filename))
            
    # ë³‘ë ¬ ì²˜ë¦¬ ì‹œì‘
    results = await asyncio.gather(*tasks)
    
    # ê²°ê³¼ ì·¨í•© ë° ì¢…í•© ë¦¬í¬íŠ¸ ì‘ì„±
    valid_results = [r for r in results if r.get("type") != "error"]
    context_texts = []
    
    for r in valid_results:
        summary = r.get("summary", "")
        context_texts.append(f"--- File: {r['filename']} ---\n{summary[:3000]}") # ë„ˆë¬´ ê¸¸ë©´ ìë¦„
    
    final_context = "\n".join(context_texts)
    final_report = "ë¶„ì„ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."
    
    if final_context:
        try:
            print(f"ğŸ“ Generating Final Report with {TEXT_MODEL}...")
            res = await asyncio.to_thread(
                ollama_client.chat,
                model=TEXT_MODEL,
                messages=[{
                    'role': 'user', 
                    'content': f"Synthesize these scientific analysis results into a structured Markdown report. Highlight correlations between different data sources:\n\n{final_context}"
                }]
            )
            final_report = res['message']['content']
            print("âœ… Report Generated!")
            
        except Exception as e:
            final_report = f"âŒ Final Report Error: {str(e)}"

    return {
        "results": results,
        "final_report": final_report
    }

@app.get("/", response_class=HTMLResponse)
async def serve_index():
    if os.path.exists("index.html"):
        return FileResponse("index.html")
    return "<h1>index.html not found</h1>"

if __name__ == "__main__":
    import uvicorn
    # ì‹¤í–‰
    uvicorn.run(app, host="0.0.0.0", port=8000)


# ... (ìœ„ìª½ import ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ ìœ ì§€) ...

@asynccontextmanager
async def lifespan(app: FastAPI):
    print(f"ğŸš€ Starting A6000 Analysis Server (Ollama Mode)")
    print(f"ğŸ¯ Vision Model: {VISION_MODEL}")
    print(f"ğŸ¯ Text Model:   {TEXT_MODEL}")
    
    # ì—°ê²° í…ŒìŠ¤íŠ¸ ë° ëª¨ë¸ í™•ì¸ ë¡œì§ (ì•ˆì „í•˜ê²Œ ìˆ˜ì •ë¨)
    try:
        print(f"ğŸ“¡ Connecting to Ollama at {OLLAMA_HOST}...")
        
        # 1. ë¦¬ìŠ¤íŠ¸ ê°€ì ¸ì˜¤ê¸°
        response = ollama_client.list()
        
        # 2. ëª¨ë¸ ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ (êµ¬ì¡° ë³€í™”ì— ëŒ€ì‘)
        # responseê°€ dictë¼ë©´ 'models' í‚¤ë¥¼ ì°¾ê³ , ì•„ë‹ˆë©´ response ìì²´ë¥¼ ë¦¬ìŠ¤íŠ¸ë¡œ ê°€ì •
        raw_models = response.get('models', []) if isinstance(response, dict) else response

        # 3. ì„¤ì¹˜ëœ ëª¨ë¸ ì´ë¦„ ì¶”ì¶œ (name í‚¤ê°€ ì—†ìœ¼ë©´ model í‚¤ë¥¼ ì‚¬ìš©)
        installed_models = []
        for m in raw_models:
            # mì´ ë”•ì…”ë„ˆë¦¬ì¸ ê²½ìš°
            if isinstance(m, dict):
                # 'name'ì´ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ 'model'ì„ ì”€
                m_name = m.get('name') or m.get('model')
            else:
                # mì´ ê°ì²´(Object)ì¸ ê²½ìš° ì†ì„±ìœ¼ë¡œ ì ‘ê·¼
                m_name = getattr(m, 'name', None) or getattr(m, 'model', None)
            
            if m_name:
                installed_models.append(m_name)
        
        print(f"ğŸ“‹ Installed Models: {installed_models}")

        # 4. ëª¨ë¸ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
        # ì •í™•íˆ ì¼ì¹˜í•˜ì§€ ì•Šì•„ë„ ë¶€ë¶„ ì¼ì¹˜í•˜ë©´ í†µê³¼ (íƒœê·¸ ë²„ì „ ì°¨ì´ ë“± ë°©ì§€)
        is_vision_ready = any(VISION_MODEL in m for m in installed_models)
        
        if not is_vision_ready:
            print(f"âš ï¸ Warning: Vision model '{VISION_MODEL}' might not be pulled yet.")
            print(f"   (Detected models: {installed_models})")
            print(f"   If execution fails, run: ollama pull {VISION_MODEL}")
        else:
            print(f"âœ… Vision Model '{VISION_MODEL}' is ready.")
            
    except Exception as e:
        # ì—ëŸ¬ê°€ ë‚˜ë„ ì„œë²„ê°€ êº¼ì§€ì§€ ì•Šë„ë¡ ê²½ê³ ë§Œ ì¶œë ¥í•˜ê³  ë„˜ì–´ê°
        print(f"âš ï¸ Warning: Check Ollama Connection (Error: {e})")
        print("   Proceeding anyway... (Server will try to connect on demand)")
    
    yield
    print("ğŸ‘‹ Shutting down server...")

# ... (ì•„ë˜ìª½ app = FastAPI(...) ë¶€í„°ëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€) ...



